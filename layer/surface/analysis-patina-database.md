---
id: analysis-patina-database
status: active
created: 2025-11-23
updated: 2025-12-09
oxidizer: nicabar
tags: [analysis, database, sqlite, code-analysis]
references: [architecture-patina-system, architecture-neuro-symbolic]
---

# Patina Database Deep Dive Analysis

## Executive Summary

Patina uses **4 database systems** across 6 database files for different purposes:

1. **code.db** - Code analysis (Tree-sitter AST extraction)
2. **facts.db** - Session extraction (OLD persona/session system)  
3. **observations/** - Neuro-symbolic hybrid storage (NEW system) ✅ ACTIVE
4. **beliefs/** - Neuro-symbolic hybrid storage (NEW system) ⚠️ UNUSED

---

## 1. Code Database (code.db)

**Path:** `.patina/data/code.db`  
**Size:** 2.4M  
**Created By:** `patina scrape code`  
**Purpose:** Code symbol extraction and analysis

### Schema (9 tables):
- `function_facts` (689 rows) - Function signatures, parameters, return types
- `type_vocabulary` - Type definitions (structs, enums, traits)  
- `import_facts` - Import statements and dependencies
- `constant_facts` - Constants, macros, statics
- `call_graph` (8,475 rows) - Function call relationships
- `code_search` (1,237 rows) - Searchable code index
- `member_facts` - Struct/impl members
- `skipped_files` - Files that couldn't be parsed
- `index_state` - Incremental update tracking

### Data Flow:
```
Source Code 
  ↓ Tree-sitter parsers (Rust, Go, Python, JS, TS, C, Cairo, Solidity)
  ↓ patina-metal crate (AST extraction)
  ↓ src/commands/scrape/code/
  ↓
code.db (SQLite)
```

### Commands:
- `patina scrape code` - Index current project
- `patina scrape code --repo <name>` - Index reference repo → `layer/dust/repos/<repo>.db`
- `patina ask <query>` - Query code database

**Status:** ✅ ACTIVE, well-maintained

---

## 2. Facts Database (facts.db)

**Path:** `.patina/data/facts.db`  
**Size:** 184K  
**Created By:** Session extraction scripts (shell-based)  
**Purpose:** Track development sessions, patterns, beliefs (OLD SYSTEM)

### Schema (17 tables):

**Core Tables:**
- `sessions` (7 rows) - Development sessions with Git metadata
- `patterns` (11 rows) - Observed development patterns
- `decisions` (5 rows) - Design decisions made
- `technologies` (7 rows) - Tech stack choices
- `challenges` (?) - Problems and solutions

**Belief System Tables:**
- `beliefs` (25 rows) - Codified beliefs with confidence scores
- `belief_observations` - Evidence links (pattern/decision/tech → belief)
- `belief_conflicts` - Contradiction tracking
- `belief_domains` - Multi-domain belief mapping

**Persona System Tables:**
- `questions` - Generated questions for user
- `question_evidence` - Evidence for each question
- `question_domains` - Domain classification
- `persona_sessions` - Interactive belief discovery sessions
- `persona_session_questions` - Q&A tracking
- `domains` - Knowledge domains (rust, ecs, security, etc.)

### Data Flow:
```
Session work
  ↓ session-git-end.sh
  ↓ Distillation prompt (LLM extraction)
  ↓ Manual/scripted SQLite inserts
  ↓
facts.db (SQLite)
```

### Commands:
- `/session-end` (Claude command) - Distills session → facts.db
- `persona-start.sh` - Interactive belief discovery
- `patina ask --db facts.db` (fallback path mentioned in code)

### Issues:
1. **No Rust code creates this** - All creation is shell script + manual SQL
2. **Persona system references `.patina/db/facts.db`** ✅ Fixed in this session
3. **Parallel belief system** - `facts.db beliefs` vs `beliefs/beliefs.db` (different schemas!)
4. **Session extraction is shell-based** - No `patina session extract` command exists

**Status:** ⚠️ LEGACY SYSTEM, partially deprecated

---

## 3. Observations Database (NEW System)

**Path:** `.patina/data/observations/`  
**Files:**
- `observations.db` (332K) - Metadata (SQLite)
- `observations.usearch` (3.2M) - Vector index (HNSW)

**Created By:** `ObservationStorage::open()` (Rust)  
**Purpose:** Neuro-symbolic hybrid storage for session observations

### Schema (1 table):
```sql
CREATE TABLE observations (
    rowid INTEGER PRIMARY KEY AUTOINCREMENT,
    id TEXT UNIQUE NOT NULL,           -- UUID
    observation_type TEXT NOT NULL,     -- pattern, decision, challenge, technology
    content TEXT NOT NULL,              -- Human-readable text
    metadata TEXT,                      -- JSON (source_type, reliability, session_id, etc.)
    created_at TEXT NOT NULL
);
```

### Data:
- **992 observations** total
  - 388 decisions
  - 310 challenges  
  - 267 patterns
  - 27 technologies

### Architecture:
**Hybrid Storage Pattern:**
- SQLite = Metadata + structured queries
- USearch = Vector embeddings for semantic search (HNSW index)
- Paired storage: Each row gets both SQLite entry + vector embedding

### Data Flow:
```
Session distillation
  ↓ LLM extraction (from session markdown)
  ↓ ObservationStorage::add_observation()
  ↓ 
  ├─ observations.db (SQLite - metadata)
  └─ observations.usearch (USearch - vectors)
       ↑ Generated by embeddings command
```

### Commands:
- `patina embeddings generate` - Generate vector embeddings
- `patina query semantic <text>` - Semantic search over observations
- `patina belief validate <statement>` - Neuro-symbolic reasoning using observations

**Status:** ✅ ACTIVE, modern neuro-symbolic system

---

## 4. Beliefs Database (NEW System)

**Path:** `.patina/data/beliefs/`  
**Files:**
- `beliefs.db` (16K) - Metadata (SQLite)
- `beliefs.usearch` - Vector index (not created yet)

**Created By:** `BeliefStorage::open()` (Rust)  
**Purpose:** Neuro-symbolic hybrid storage for beliefs

### Schema (1 table):
```sql
CREATE TABLE beliefs (
    rowid INTEGER PRIMARY KEY AUTOINCREMENT,
    id TEXT UNIQUE NOT NULL,           -- UUID
    content TEXT NOT NULL,              -- Belief text
    metadata TEXT,                      -- JSON
    created_at TEXT NOT NULL
);
```

### Data:
- **0 beliefs** - NEVER POPULATED

### Issue:
**Two separate belief systems exist:**

| facts.db beliefs | beliefs.db beliefs |
|-----------------|-------------------|
| 25 beliefs | 0 beliefs |
| Structured schema | Generic schema |
| Links to questions, sessions | Generic hybrid storage |
| Shell-based creation | Rust API |
| OLD persona system | NEW neuro-symbolic system |

### Commands:
- `BeliefStorage::open()` - API exists but unused
- `SemanticSearch::add_belief()` - API exists but unused
- `SemanticSearch::search_beliefs()` - API exists but unused

**Status:** ⚠️ IMPLEMENTED BUT UNUSED - Code exists, never integrated

---

## Database Interaction Map

```
┌─────────────────────────────────────────────────────┐
│ COMMAND: patina scrape code                          │
└────────────────┬────────────────────────────────────┘
                 ↓
         .patina/data/code.db (2.4M)
         - 689 functions, 8475 calls
         - Tree-sitter AST analysis
                 
┌─────────────────────────────────────────────────────┐
│ COMMAND: /session-end (Claude)                      │
└────────────────┬────────────────────────────────────┘
                 ↓
         .patina/data/facts.db (184K) [OLD]
         - 7 sessions, 11 patterns, 25 beliefs
         - Shell script + manual SQL inserts
                 │
                 └──> (future migration?)
                 
┌─────────────────────────────────────────────────────┐
│ COMMAND: ObservationStorage::add_observation()      │
└────────────────┬────────────────────────────────────┘
                 ↓
         .patina/data/observations/ [NEW]
         - observations.db (992 obs)
         - observations.usearch (3.2M vectors)
                 ↓
         ┌───────┴────────┐
         ↓                ↓
  patina query semantic   patina belief validate
  (semantic search)       (neuro-symbolic reasoning)
  
┌─────────────────────────────────────────────────────┐
│ COMMAND: BeliefStorage::add_belief() [NEVER CALLED] │
└────────────────┬────────────────────────────────────┘
                 ↓
         .patina/data/beliefs/ [UNUSED]
         - beliefs.db (0 beliefs)
         - beliefs.usearch (doesn't exist)
```

---

## Key Findings

### ✅ Well-Designed:
1. **code.db** - Solid code analysis system
2. **observations/** - Modern neuro-symbolic hybrid storage actively used
3. **Hybrid storage pattern** - SQLite + USearch is elegant

### ⚠️ Issues Found:

1. **Duplicate Belief Systems**
   - `facts.db` has 25 beliefs (OLD, shell-based, structured schema)
   - `beliefs.db` has 0 beliefs (NEW, Rust API, never populated)
   - API exists but not integrated into any command

2. **facts.db is Orphaned**
   - Created by shell scripts, not Rust code
   - No `patina session extract` command exists
   - Session extraction happens via `/session-end` Claude command
   - Manual SQL inserts, no type safety

3. **Missing Migration Path**
   - Old persona system (`facts.db`) has data
   - New neuro-symbolic system (`observations.db`, `beliefs.db`) is better architecture
   - No migration tool to move 25 beliefs from old → new system

4. **Unused Code**
   - `BeliefStorage` fully implemented but never called
   - `SemanticSearch::add_belief()` exists but unused
   - `SemanticSearch::search_beliefs()` exists but unused

---

## Recommendations

### Option 1: Deprecate facts.db, Use Hybrid Storage
**Migrate everything to the new neuro-symbolic system:**
- Keep `observations.db` (already populated with 992 items) ✅
- Start using `beliefs.db` for beliefs (migrate 25 from facts.db)
- Deprecate `facts.db` entirely
- Convert shell scripts to Rust commands

**Benefits:**
- One belief system, not two
- Type-safe Rust code instead of shell scripts
- Unified hybrid storage pattern
- Better semantic search capabilities

### Option 2: Keep facts.db, Remove Unused Code
**Double down on the old system:**
- Keep `facts.db` as primary belief store
- Remove unused `BeliefStorage` code
- Remove unused `beliefs/` directory
- Keep observations separate (they work well)

**Benefits:**
- Simpler, remove dead code
- Preserve existing 25 beliefs
- Less migration work

### Option 3: Hybrid Approach
**Use both systems for different purposes:**
- `facts.db` = Session tracking, patterns, structured belief relationships
- `beliefs.db` = High-confidence beliefs with vector search
- `observations.db` = Raw observations

**Benefits:**
- Leverage both systems' strengths
- Structured queries for session history
- Semantic search for beliefs/observations

---

## Questions for Discussion

1. **What's the vision for beliefs?**
   - Structured schema with links to evidence? (facts.db style)
   - Generic content + metadata + vectors? (beliefs.db style)

2. **Should session extraction be Rust commands?**
   - Currently shell scripts + LLM + manual SQL
   - Could be `patina session extract` command

3. **How to handle the 25 existing beliefs in facts.db?**
   - Migrate to beliefs.db?
   - Keep in facts.db and integrate with new system?
   - Archive and start fresh?

4. **What's the relationship between patterns and observations?**
   - Both track similar things (patterns, decisions, challenges)
   - Different schemas and storage strategies
   - Should they unify?

---

## Database File Sizes Summary

```
.patina/data/
├── code.db                    2.4M  [ACTIVE - code analysis]
├── facts.db                   184K  [LEGACY - session extraction]
├── beliefs/
│   └── beliefs.db              16K  [UNUSED - 0 beliefs]
└── observations/
    ├── observations.db        332K  [ACTIVE - 992 observations]
    └── observations.usearch   3.2M  [ACTIVE - vector index]

Total: ~6.2M across 5 files
```
