# Session: Phase 2.8
**ID**: 20251215-111922
**Started**: 2025-12-15T16:19:22Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251215-111922-start
**Starting Commit**: d31381d6f4e8bd2ccc3e84b6de2a3cc03e680579

## Previous Session Context
Last session ("Phase 3 review before begin") established the **Phase 2.8 architecture** for multi-project RAG. Key insight: an initial implementation attempt that threaded `QueryOptions` through oracles was identified as wrong - it violated clean layering by leaking MCP-specific concerns into the retrieval layer. The **correct architecture** puts federation logic in `QueryEngine` (one place), keeps oracles simple with `query(query, limit)` signature, and treats MCP as a thin adapter. Uncommitted changes from the wrong approach need reverting before implementing the correct solution. Session documented the layering principle in spec-agentic-rag.md.

## Goals
- [ ] Phase 2.8

## Activity Log
### 11:19 - Session Start
Session initialized with goal: Phase 2.8
Working on branch: patina
Tagged as: session-20251215-111922-start

### Phase 2.8 Implementation - COMPLETE
- Implemented QueryEngine federation (repo/all_repos support)
- Updated MCP patina_query schema with repo params
- Implemented include_issues properly (oracle config at construction time)
- Benchmark: MRR 0.624 (no regression)
- Commits: 30d2ba24, 7c831c13, f1bb401a

### Design Discussion: Restructuring ~/.patina and .patina/

**Key Insight**: `layer/` content is LLM-edited, not human-edited. Sessions, patterns, distillations - all written by AI with human review. This changes whether it should be visible or hidden.

**The Principle (from git):**
- Separate source of truth from derived artifacts
- Source = valuable, back it up
- Derived = rebuildable from source

**Current Problem:**
- `~/.patina/personas/` mixes source (events/) with derived (materialized/)
- No clear separation of valuable vs rebuildable

**Proposed Structure - Project Level:**
```
.patina/
├── layer/                  # AI memory (git-tracked)
│   ├── core/               # Distilled patterns
│   ├── surface/            # Active knowledge
│   ├── dust/               # Archived
│   └── sessions/           # Raw session logs
└── data/                   # Derived indices (gitignored)
    ├── patina.db
    └── embeddings/
```

**Proposed Structure - User Level:**
```
~/.patina/
├── layer/                  # AI memory (valuable)
│   └── personas/
│       └── default/
│           └── events/*.jsonl
├── registry.yaml           # Project/repo index
└── cache/                  # Derived (rebuildable)
    ├── repos/              # Cloned references
    └── materialized/       # Persona indices
```

**The Model:**
- `.patina/layer/` = AI's accumulated knowledge (source of truth)
- `.patina/data/` or `cache/` = derived from layer
- `layer/` moves inside `.patina/` because it's AI-authored, not human-authored

**Git tracking:**
```gitignore
.patina/data/
.patina/cache/
# .patina/layer/ is tracked
```

**Why this works:**
1. One folder (`.patina/`) contains everything Patina-related
2. Clear internal separation: layer/ (valuable) vs data/cache/ (derived)
3. Symmetric between project and user level
4. Follows Ollama's simplicity - everything in one place
5. Aligns with XDG principle of separating data from cache

**Open Questions:**
- Is `layer/` the right name inside `.patina/`?
- Should registry.yaml live inside layer/ or at ~/.patina/ root?
- Migration path from current structure?


## Session Classification
- Work Type: pattern-work
- Files Changed:        6
- Commits:        3
- Patterns Modified:        2
- Session Tags: session-20251215-111922-start..session-20251215-111922-end
