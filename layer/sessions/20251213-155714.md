# Session: Review and Finish Phase 2
**ID**: 20251213-155714
**Started**: 2025-12-13T20:57:14Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251213-155714-start
**Starting Commit**: 67444d0a227b1b20e3e36d30c78d3f3f346d3cfd

## Previous Session Context
Last session completed **Phase 2.5e** with a PhD ML-style review (Andrew Ng approach). Key accomplishments: fixed benchmark format to use document IDs instead of keywords (creating `GroundTruth` struct), added `--oracle` ablation flag for testing individual oracles, and created `patina-dogfood-v1.json` with 20 queries. Critical discovery: index was stale (Phase 2 code not scraped), and after re-scrape MRR improved 2.9x (0.059 → 0.171). Session defined Phase 2.7 for retrieval quality fixes (lexical oracle returns 0 for code queries, need MRR > 0.3 before Phase 3). Exit criteria documented: all oracles must contribute meaningfully.

## Goals
- [~] Review and Finish Phase 2 (3/4 exit criteria met, remaining: layer doc indexing)

## Activity Log

### 15:57 - Session Start
Session initialized with goal: Review and Finish Phase 2
Working on branch: patina
Tagged as: session-20251213-155714-start

### 16:05 - Diagnosed Lexical Oracle Issue (2.7a)
**Problem:** Lexical oracle returned MRR=0.000 for all code queries
**Root Cause:** FTS5 received full natural language queries like "How does RRF fusion work?"
but searches code symbols. No match possible.

### 16:20 - Fixed FTS5 Query Preparation
**Files Changed:**
- `src/commands/scry/mod.rs` - New functions: `prepare_fts_query()`, `is_code_like()`, `extract_technical_terms()`

**Solution:**
- Detect if query is natural language vs code symbol
- Extract technical terms from natural language (stop-word filtering)
- Use OR search: "RRF OR fusion OR results OR oracles"

**Results:**
| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Lexical MRR | 0.000 | 0.436 | ∞ |
| Combined MRR | 0.171 | 0.496 | **2.9x** |
| Recall@10 | 45.0% | 55.0% | **+10%** |

### 16:35 - Implemented patina_context MCP Tool (2.7e)
**Files Changed:**
- `src/mcp/server.rs` - Added `patina_context` tool, `get_project_context()`, `read_patterns()`, `extract_summary()`

**Tool Features:**
- Returns core patterns (layer/core/*.md) and surface patterns (layer/surface/*.md)
- Optional topic filter
- Summarizes each pattern (~500 chars)

### 16:45 - CI Checks
- Fixed formatting (cargo fmt)
- All 134 tests passing (84 lib + 50 bin)
- Clippy clean

### 17:00 - Andrew Ng Style Review (Self-Critique)

**What we did wrong:**
1. **Violated "Data > Code"** - Coded stop-word filtering BEFORE understanding failure modes
2. **No error analysis before fix** - Should have implemented `--verbose` FIRST
3. **Small sample size** - 20 queries doesn't give statistical confidence
4. **Jumped to complex solution** - 80-line stop-word list without trying simpler approaches

**Lesson learned:** The fix works, but the PROCESS was wrong. Error analysis should come BEFORE coding.

### 17:15 - Implemented --verbose Error Analysis (2.7b)
**Files Changed:**
- `src/main.rs` - Added `--verbose` flag to BenchCommands::Retrieval
- `src/commands/bench/mod.rs` - Added `verbose` to BenchOptions
- `src/commands/bench/internal.rs` - Added `print_verbose_analysis()` function

**Features:**
- Shows expected vs retrieved docs for each query
- Marks matches with ✓
- For failures (RR=0): shows detailed analysis and possible causes

### 17:30 - Error Analysis Results (Critical Findings)

Ran `patina bench retrieval -q resources/bench/patina-dogfood-v1.json --verbose`

**Failing Queries Analyzed:**

| Query ID | Expected | Problem |
|----------|----------|---------|
| df04-semantic-oracle | src/retrieval/oracles/semantic.rs | "semantic" matches test files, not SemanticOracle |
| df05-lexical-oracle | src/retrieval/oracles/lexical.rs | Same issue - generic term |
| df11-scrape-code | src/commands/scrape/code/*.rs | "code" too generic |
| df15-mothership | src/mothership/*.rs | Not matching |
| df17-git-branch-safety | src/git/fork.rs | "git" matches many files |
| df19-dependable-rust | layer/core/dependable-rust.md | **NOT INDEXED** |
| df20-unix-philosophy | layer/core/unix-philosophy.md | **NOT INDEXED** |

**Root Cause #1: CamelCase Token Boundary**
```
FTS5 indexes "SemanticOracle" as ONE token
Search for "semantic" doesn't match "SemanticOracle"
But DOES match file paths like "semantic_search_integration.rs"
```

Verified:
```sql
-- Searching "semantic" returns test files, not oracle impl
SELECT symbol_name, file_path FROM code_fts WHERE code_fts MATCH 'semantic' LIMIT 5;
-- Returns: tests/semantic_search_integration.rs (file path match)
-- Misses: src/retrieval/oracles/semantic.rs (SemanticOracle is one token)
```

**Root Cause #2: Layer Docs Not Indexed**
```sql
-- Layer markdown files are NOT in FTS5 index
SELECT COUNT(*) FROM code_fts WHERE file_path LIKE '%unix-philosophy%';  -- Returns: 0
SELECT COUNT(*) FROM code_fts WHERE file_path LIKE '%dependable-rust%';  -- Returns: 0
```

The oracle .rs files ARE indexed (verified 17 symbols in semantic.rs, 16 in lexical.rs), but:
- FTS5 tokenization doesn't split CamelCase
- Layer/*.md files not scraped at all

## Key Decisions Made

**Decision: Index Layer Docs (Option C)**

Three options were considered:
- **A: Fix Tokenization** - Split CamelCase during indexing (complex, requires re-scrape)
- **B: Adjust Ground Truth** - Accept lexical's limitation, add exact symbol queries (honest but limiting)
- **C: Index Layer Docs** - Add layer/*.md to scrape pipeline (moderate, high value)

**Chosen: Option C** - Layer docs are core knowledge and should be searchable. This is the right fix.

## Next Session Tasks (Priority Order)

### 1. Index Layer Docs in Scrape Pipeline
**Files to modify:** `src/commands/scrape/`
**What to do:**
- Add layer/*.md files to scrape pipeline
- Create event_type: "pattern" or "knowledge"
- Index title, content, tags from frontmatter
- Re-run: `patina scrape && patina oxidize`

### 2. Consider CamelCase Tokenization (Optional)
**Trade-off analysis needed:**
- Splitting "SemanticOracle" → "semantic oracle semanticoracle" helps natural language
- But may hurt exact symbol searches
- Could be query-time transformation instead of index-time

### 3. Expand Ground Truth (2.7c)
After fixing layer doc indexing, expand from 20 → 50+ queries:
- Add queries that test layer doc retrieval
- Add exact symbol queries (test lexical strength)
- Add queries that should hit multiple files

### 4. Session MCP Tools (2c/2.7e)
Still pending: `patina_session_start/end/note` MCP tools

## Files Changed This Session

```
src/commands/scry/mod.rs        # FTS5 query preparation (stop-word filtering)
src/mcp/server.rs               # patina_context MCP tool
src/main.rs                     # --verbose flag
src/commands/bench/mod.rs       # verbose option
src/commands/bench/internal.rs  # print_verbose_analysis()
layer/core/build.md             # Updated phase status
```

## Current Metrics

```
Combined:  MRR 0.496 | Recall@5 47.5% | Recall@10 55.0%
Semantic:  MRR 0.220 | Recall@10 47.5%
Lexical:   MRR 0.436 | Recall@10 47.5%
```

**Exit Criteria Status:**
- [x] All oracles contribute (RRF fusion proves both help)
- [x] MRR > 0.3 (achieved 0.496)
- [x] patina_context via MCP
- [x] Error analysis exists (--verbose)
- [ ] Layer docs indexed (NEXT SESSION)

## Insights / Learnings

1. **Process matters as much as outcome** - We got good results but violated Andrew Ng principles. Error analysis FIRST, then code.

2. **FTS5 tokenization is literal** - CamelCase symbols are single tokens. "semantic" won't match "SemanticOracle".

3. **Layer docs are knowledge, should be searchable** - These are core patterns, not indexing them was an oversight.

4. **20 queries is noise, not signal** - Need 50+ for statistical confidence. Current MRR could vary significantly.

5. **Verbose output is essential** - Can't improve what you can't see failing. Should have built this first.

## Commands Reference

```bash
# Run benchmark with error analysis
patina bench retrieval -q resources/bench/patina-dogfood-v1.json --verbose

# Check if file is indexed
sqlite3 .patina/data/patina.db "SELECT COUNT(*) FROM code_fts WHERE file_path LIKE '%pattern%';"

# Test FTS5 query directly
sqlite3 .patina/data/patina.db "SELECT symbol_name, file_path FROM code_fts WHERE code_fts MATCH 'term' LIMIT 5;"

# Ablation testing
patina bench retrieval -q resources/bench/patina-dogfood-v1.json --oracle semantic
patina bench retrieval -q resources/bench/patina-dogfood-v1.json --oracle lexical
```


### 17:28 - Update (covering since 15:57)

**Git Activity:**
- Commits this session: 0
- Files changed: 6 (+517 lines)
- Last commit: 7 hours ago

**Work Completed:**
1. Fixed lexical oracle (2.7a) - MRR 0.000 → 0.436 via improved FTS5 query preparation
2. Implemented `patina_context` MCP tool (2.7e) - returns layer patterns via MCP
3. Implemented `--verbose` error analysis (2.7b) - shows expected vs retrieved per query
4. Analyzed all failing queries - discovered root causes

**Key Decisions:**
- Chose Option C (index layer docs) over tokenization fixes - layer docs are core knowledge
- Decided NOT to undo the stop-word fix despite process concerns - working code stays
- Andrew Ng review identified process violation but outcome is valid

**Challenges & Solutions:**
- Unicode truncation panic in patina_context → fixed with `.chars().take(500)`
- FTS5 CamelCase issue discovered: "SemanticOracle" is one token, "semantic" won't match
- Layer docs (layer/*.md) not indexed at all - explains df19/df20 failures

**Patterns Observed:**
1. Error analysis BEFORE coding would have saved time (Ng principle)
2. FTS5 tokenization is literal - CamelCase symbols are single tokens
3. 20 queries insufficient for statistical confidence
4. Verbose output essential for debugging retrieval

**Recommendation:** Commit now, then next session implement 2.7f (index layer docs)

## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20251213-155714-start..session-20251213-155714-end
