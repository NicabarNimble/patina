# Session: Launcher Stash Fix and Define Owner and Contrib meaning and functions
**ID**: 20251211-081016
**Started**: 2025-12-11T13:10:16Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251211-081016-start
**Starting Commit**: 8d60af17a74d1a7b10c02c152ce01d79b34c87ef

## Previous Session Context
Last session completed the launcher branch safety implementation: added "Are you lost?" prompt for non-patina projects (shows path, git status, remote URL, and offers to initialize), implemented "Do and Inform" branch safety model with auto-stash of dirty working tree, auto-switch to patina branch, and auto-rebase if behind main. New git operations added: `stash_push()`, `checkout()`, `rebase()`, `fetch()`. All CI checks pass, ~340 lines changed. Key insight: enum return types (`BranchAction`) help callers handle multi-outcome functions explicitly.

## Goals
- [ ] Launcher Stash Fix and Define Owner and Contrib meaning and functions

## Activity Log
### 08:10 - Session Start
Session initialized with goal: Launcher Stash Fix and Define Owner and Contrib meaning and functions
Working on branch: patina
Tagged as: session-20251211-081016-start


### 08:34 - Update (covering since 08:10)

**Git Activity:**
- Commits this session: 0
- Files changed: 1
- Last commit: 27 minutes ago

**Work Completed:**
- Fixed stash issue: Changed `stash_push()` to use `--include-untracked` flag (`src/git/operations.rs:245`)
- Researched contribution requirements for target repos: dojo, dust, death-mountain, Algora bounties
- Discussed owner vs contrib mode simplification

**Key Decisions:**
1. **Stash fix**: Use `--include-untracked` always - simpler than detecting conflicts
2. **Owner vs Contrib insight**: If patina branch is always the truth anchor, "owner" vs "contrib" is just a CI configuration choice, not a patina behavior difference
3. **Build everything as contrib**: Patina artifacts stay on patina branch, stripping happens at PR time
4. **Proposed simplification**: Remove mode from config, provide `patina pr` command for clean PRs

**Contribution Research:**
- Dojo: Rust+Cairo, feature branches → main, `cargo nextest run`
- Dust: TypeScript+Rust monorepo, standard GitHub flow
- Death-Mountain: Cairo+TS, Dojo 1.5.1, `sozo build`, 23 open issues
- Algora: `/claim <issue>` in PR body, autopay on merge

**Patterns Observed:**
- All repos follow standard fork → feature branch → PR to upstream/main
- The patina branch workflow maps cleanly: work on patina, create clean feature branch, PR to upstream
- Mode distinction may be unnecessary if tooling handles artifact stripping

---

## Major Architectural Insights (Session Reference)

This section documents the architectural evolution discussed in this session. These insights should inform future development.

### 1. "Upstream is a Way of Life"

**Key Insight:** Every repo has an upstream. Always. No exceptions.

| Repo Type | upstream.repo | upstream.remote | Who Owns Main |
|-----------|---------------|-----------------|---------------|
| Your project | `you/repo` | `origin` | You |
| OSS contrib | `them/repo` | `upstream` | Them |
| Work project | `company/repo` | `origin` | Team |

**The Universal Model:**
```
patina branch ──PR──► upstream.branch
(your workspace)      (the truth)
```

Even patina itself has an upstream - it's just that you own it:
```toml
[upstream]
repo = "nicabar/patina"
branch = "main"
remote = "origin"
include_artifacts = true  # your choice
```

### 2. The `.patina/` as Single Source of Truth (Git-Inspired)

**Inspiration:** Git keeps everything in `.git/`. The working tree is a "projection" of internal state.

**Proposed Structure:**
```
.patina/                          # THE source of truth (like .git/)
├── HEAD                          # Current session pointer
├── config.toml                   # All config (like .git/config)
│
├── context/                      # Context management
│   ├── project.md                # YOUR project knowledge (source for CLAUDE.md)
│   ├── active-session.md         # Current session
│   └── last-session.md           # Pointer to last session
│
├── layer/                        # Knowledge storage (CONSIDER MOVING HERE)
│   ├── core/                     # Eternal patterns
│   ├── surface/                  # Active docs
│   ├── dust/                     # Archived
│   └── sessions/                 # Session history
│
├── adapters/                     # Frontend adapter sources
│   ├── claude/
│   │   ├── commands/             # Slash commands (source of truth)
│   │   ├── bin/                  # Scripts
│   │   └── settings.json
│   └── gemini/
│
├── hooks/                        # Automation (like .git/hooks/)
│   ├── pre-pr                    # Before PR creation
│   ├── post-session              # After session end
│   └── pre-launch                # Before frontend launch
│
├── refs/                         # References (like .git/refs/)
│   └── upstream                  # Upstream pointer
│
├── logs/                         # History (like .git/logs/)
│   └── reflog                    # All changes
│
└── backups/                      # Backups before modifications
```

**External "Projections" (must live outside for tool compatibility):**
```
project/
├── .patina/                # Source of truth (self-contained)
│
├── CLAUDE.md               # PROJECTION: generated from .patina/context/project.md
├── .claude/                # PROJECTION: symlinks to .patina/adapters/claude/
│   ├── commands/ → ../.patina/adapters/claude/commands/
│   └── settings.json
│
├── GEMINI.md               # PROJECTION: generated
├── .gemini/                # PROJECTION: symlinks
│
└── (upstream's files)      # NEVER TOUCHED by patina
```

### 3. Git/Patina Conceptual Mapping

| Concept | Git | Patina |
|---------|-----|--------|
| Internal state | `.git/` | `.patina/` |
| Working tree | Files outside `.git/` | CLAUDE.md, .claude/ (projections) |
| Config | `.git/config` | `.patina/config.toml` |
| History | `.git/logs/` | `.patina/logs/`, `.patina/layer/sessions/` |
| Hooks | `.git/hooks/` | `.patina/hooks/` |
| References | `.git/refs/` | `.patina/refs/` |
| Objects | `.git/objects/` | `.patina/layer/` (knowledge objects) |
| HEAD | `.git/HEAD` (current branch) | `.patina/HEAD` (current session) |

### 4. File Ownership and Conflict Prevention

**The Rule:** Patina owns `.patina/`. Everything else belongs to upstream or projections.

**For Contributions (death-mountain, dojo, dust):**
- `.patina/` → Your knowledge, NEVER goes upstream
- `CLAUDE.md` (upstream's) → NEVER TOUCH
- `.patina/context/project.md` → YOUR additions (LLM reads both)

**For Owned Repos (patina itself):**
- `.patina/` → Can go to main (your choice)
- `CLAUDE.md` → Generated, goes to main for collaborators

**LLM Context Loading:**
1. Read upstream's CLAUDE.md (if exists) - their rules
2. Read `.patina/context/project.md` - your additions
3. Read `.patina/layer/` - deep knowledge

### 5. Updated Config Schema

```toml
# .patina/config.toml

[project]
name = "death-mountain"
created = "2025-12-11T13:10:16Z"

[upstream]
repo = "Provable-Games/death-mountain"  # Always present
branch = "main"
remote = "upstream"                      # "origin" if you own it
include_patina = false                   # .patina/ in PRs?
include_adapters = false                 # CLAUDE.md, .claude/ in PRs?

[ci]
checks = ["sozo build", "scarb fmt --check"]
branch_prefix = "feat/"

[frontends]
allowed = ["claude"]
default = "claude"

[embeddings]
model = "e5-base-v2"
```

### 6. PR Creation Flow (LLM-Driven)

```
User: "Create a PR for the beast stat fix"

LLM:
1. Reads .patina/config.toml
   - upstream.repo = "Provable-Games/death-mountain"
   - upstream.branch = "main"
   - include_patina = false
   - include_adapters = false
   - ci.checks = ["sozo build"]

2. Runs CI checks locally
   sozo build           ✓
   scarb fmt --check    ✓

3. Creates clean branch
   git checkout -b feat/beast-stat-fix
   # Excludes: .patina/, layer/, CLAUDE.md, .claude/

4. Pushes and creates PR
   git push -u origin feat/beast-stat-fix
   gh pr create --repo Provable-Games/death-mountain --base main

5. Returns to patina branch
   git checkout patina
```

### 7. Contribution Workflow Walkthroughs

**Target Repos Researched:**

| Repo | Stack | CI Checks | Branch Convention |
|------|-------|-----------|-------------------|
| death-mountain | Cairo + TS, Dojo 1.5.1 | `sozo build`, `scarb test` | feat/, fix/ |
| dojo | Rust + Cairo | `cargo nextest run`, `cargo clippy` | fix-*, feat-* |
| dust | TypeScript + Rust | `pnpm lint`, `pnpm test` | Standard |
| Algora | Various | Repo-specific | `/claim <issue>` in PR |

**Standard Flow:**
1. Fork repo on GitHub
2. Clone your fork, add upstream remote
3. Run `patina` → creates patina branch, initializes .patina/
4. Configure `[upstream]` section
5. Work on patina branch
6. Ask LLM to create PR → clean branch created, artifacts excluded

### 8. Platform Considerations

**Patina is Mac-first (Apple Silicon):**
- Primary development environment: macOS on Apple Silicon
- ONNX embeddings via `ort` crate (cross-platform)
- Linux functionality via Docker (YOLO containers, experiments)
- Windows: Not primary target but should work

**Implications for architecture:**
- Symlinks work well on Mac (for projections)
- Docker for Linux testing/builds
- No Python dependencies at runtime

### 9. Open Questions and Future Work

**Moving `layer/` inside `.patina/`:**
- **Status:** NEEDS CAREFUL PLANNING before execution
- **Pros:** True self-containment, cleaner exclusion
- **Cons:** Breaking change, migration complexity, longer paths
- **Decision:** Document thoroughly, plan migration, execute later

**Symlinks vs Copies for Projections:**
- Symlinks: DRY, always in sync, native on Mac/Linux
- Copies: Work on Windows, survive `.patina/` deletion
- **Recommendation:** Symlinks on Mac, with copy fallback

**Handling Upstream's Existing CLAUDE.md:**
- Option A: Never touch, use `.patina/context/additions.md`
- Option B: Merge upstream + yours at runtime
- **Recommendation:** Option A (safer, no conflicts)

**Hook System:**
- `.patina/hooks/pre-pr` → Run before PR creation
- `.patina/hooks/pre-launch` → Run before frontend launch
- `.patina/hooks/post-session` → Run after session end
- **Status:** Design phase, not implemented

### 10. Code Changes This Session

| File | Change |
|------|--------|
| `src/git/operations.rs:245` | `stash_push()` now uses `--include-untracked` |
| `src/project/internal.rs` | Removed `mode` field, added `UpstreamSection`, `CiSection` |
| `src/project/mod.rs` | Export new types |
| `src/commands/init/internal/config.rs` | Updated for new schema |
| `layer/core/build.md` | Marked tasks complete |
| `layer/surface/build/spec-launcher-architecture.md` | Updated docs, new config schema |

**CI Status:** All checks pass (fmt, clippy, tests)

### 11. Key Principles Established

1. **Upstream is universal** - Every repo has one, even owned repos
2. **`.patina/` is sacred** - Single source of truth, self-contained
3. **Projections are derived** - CLAUDE.md, .claude/ generated from .patina/
4. **Never touch upstream files** - Upstream's CLAUDE.md stays upstream's
5. **LLM drives git complexity** - Config provides metadata, LLM handles operations
6. **Mac-first, Linux via Docker** - Apple Silicon is home
7. **Avoid PR rejection** - CI checks, clean branches, proper conventions


### 09:57 - Update (covering since 08:34)

**Git Activity:**
- Commits this session: 0
- Files changed: 6
- Last commit: 2 hours ago

**Work Completed:**
- Implemented `UpstreamSection` with `include_patina` and `include_adapters` flags
- Added 2 new tests: `test_upstream_config()` and `test_upstream_config_owned_repo()`
- Updated spec-launcher-architecture.md with complete upstream config schema
- Documented comprehensive architectural insights (11 sections) in active-session.md
- All 83 tests pass including new upstream tests

**Key Decisions:**
1. **Every repo has upstream**: Even owned repos - upstream is universal, not just for contributions
2. **`include_patina` flag**: Controls whether `.patina/` goes in PRs (default: false)
3. **`include_adapters` flag**: Controls whether CLAUDE.md, .claude/ go in PRs (default: false)
4. **`remote` field semantics**: "upstream" for forks, "origin" if you own the repo
5. **Git-inspired `.patina/` structure**: Proposed reorganization following `.git/` model (documented for future)

**Code Changes:**
- `src/project/internal.rs`: +119 lines - UpstreamSection with include flags, 2 tests
- `src/git/operations.rs`: `--include-untracked` for stash
- `layer/surface/build/spec-launcher-architecture.md`: Updated config schema
- `layer/core/build.md`: Marked tasks complete

**Challenges Faced:**
- Clippy caught derivable Default impl for CiSection - fixed with `#[derive(Default)]`
- Needed to update init config to handle new optional fields

**Patterns Observed:**
- Serde's `#[serde(default)]` makes optional fields with defaults very clean
- Test-driven validation: writing tests for contrib vs owned repo scenarios clarified the design
- Documentation-in-session: comprehensive notes in active-session.md serve as future reference

**Status:** Ready to commit - all checks pass, ~176 lines changed across 6 files


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20251211-081016-start..session-20251211-081016-end
