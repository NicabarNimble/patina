# Session: spec-secrets-v2
**ID**: 20251224-121305
**Started**: 2025-12-24T17:13:05Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251224-121305-start
**Starting Commit**: 3123c03859c0c880bec7b3333774f14552045e23

## Previous Session Context
Designed `spec-secrets-v2.md` - a FOSS local vault using age encryption + macOS Keychain, replacing the 1Password-based v1 which had container/CI limitations. Consulted a second LLM for design review which caught real issues (session cache persistence, Touch ID frequency). Archived 7 completed specs to git tags. Three spec gaps remain unresolved: (1) session cache persistence (no daemon but process is short-lived), (2) `add` triggering Touch ID (decrypt→modify→re-encrypt), (3) Docker injection mechanism not specified.

## Goals
- [x] Review spec-secrets-v2 before implementation
- [x] Resolve 3 spec gaps (session cache, add Touch ID, Docker injection)
- [x] Major design evolution: layered vaults (global + project)
- [ ] Implementation

## Activity Log
### 12:13 - Session Start
Session initialized with goal: spec-secrets-v2
Working on branch: patina
Tagged as: session-20251224-121305-start

### 12:13-13:00 - Spec Review & Gap Resolution

**Original 3 gaps resolved:**
1. **Session cache** → `secrets run` decrypts (Touch ID), `serve` is passive cache only
2. **Add requires Touch ID** → Accepted as intended (privileged operation)
3. **Docker injection** → Documented: env var inheritance, no special mechanism

**Major design evolution discovered:**
- Pivoted from single global vault to **layered vaults** (global + project)
- Project vault enables: CI/CD (vault in repo), team sharing (multi-recipient)
- This is a full rewrite of secrets module, not evolution of v1

**Key decisions:**
- Identity resolution: `PATINA_IDENTITY` env → Keychain (CI/headless support)
- Vault merge: global first, project overrides
- Recipients: global has one (you), project has many (team)
- Cache unlock: `secrets run` always decrypts, `serve` only stores

**Spec sections updated:**
- Solution diagram (dual vaults)
- Coverage matrix (CI, team)
- Command surface (recipient commands)
- Behavior rules (merge, --global)
- File layout (both vaults)
- UX flows (CI setup, team onboarding/offboarding)
- Technical design (identity resolution, vault resolution, session caching)
- Public API (dual vault, recipients)
- Acceptance criteria (18 items)

**Impact analysis:**
- internal.rs: DELETE (752 lines of 1Password code)
- New modules: identity.rs, vault.rs, keychain.rs, session.rs, registry.rs, recipients.rs
- Reusable: validation functions, project requirements loading


## Session Classification
- Work Type: pattern-work
- Files Changed:        1
- Commits:        1
- Patterns Modified:        1
- Session Tags: session-20251224-121305-start..session-20251224-121305-end
