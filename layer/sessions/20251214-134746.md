# Session: Index
**ID**: 20251214-134746
**Started**: 2025-12-14T18:47:46Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251214-134746-start
**Starting Commit**: 5bcf8320dd1ef5a6e83bc66618299bb6800bba4a

## Previous Session Context
Last session **completed Phase 2.7a-e** (lexical oracle fix, verbose analysis, patina_context MCP tool). Key accomplishment: fixed lexical oracle MRR from 0.000 → 0.436 by preparing FTS5 queries with stop-word filtering. Combined MRR jumped 2.9x to 0.496. Critical discovery from `--verbose` error analysis: layer docs (layer/*.md) are **not indexed at all** - explains failures for queries about dependable-rust and unix-philosophy patterns. Also found FTS5 tokenization issue where CamelCase symbols like "SemanticOracle" are single tokens. **Decision made: Option C - index layer docs as next priority** (Phase 2.7f). Exit criteria: 4/5 met, remaining task is layer doc indexing.

## Goals
- [ ] Index layer docs in scrape pipeline (Phase 2.7f)
- [ ] Continue lab testing with improved data
- [ ] Run benchmarks to verify improvements

## Activity Log
### 13:47 - Session Start
Session initialized with goal: Index
Working on branch: patina
Tagged as: session-20251214-134746-start


### 17:02 - Update (covering since 13:47)

**Git Activity:**
- Commits this session:        1
- Files changed: 6 (550 insertions)
- Last commit: 3 hours ago

**Work Completed:**
- Implemented Phase 2.7f: Layer pattern indexing
- Created `src/commands/scrape/layer/mod.rs` (new scraper module)
- Parses YAML frontmatter from layer/*.md files (id, layer, status, tags, refs)
- Creates `pattern.core` and `pattern.surface` event types in eventlog
- Added FTS5 index (`pattern_fts`) for lexical search
- Updated oxidize to include patterns in semantic index (ID offset 2B+)
- Updated scry to enrich pattern results with pattern metadata
- Added `patina scrape layer` CLI subcommand
- 25 patterns now indexed (7 core + 18 surface)

**Key Decisions:**
- Followed sessions scraper pattern for consistency (dependable-rust principle)
- Used ID offset strategy (2B for patterns, 1B for code) to avoid collisions
- Joined patterns table with pattern_fts to get content for embeddings
- Used multiline regex for YAML frontmatter parsing

**Challenges Faced:**
- Initial regex didn't parse frontmatter correctly (missing multiline mode)
- Oxidize failed on `content` column that didn't exist in patterns table (only in FTS5)
- Clippy caught manual_strip pattern - fixed with strip_prefix()

**Patterns Observed (Critique - Andrew Ng style):**
- Error analysis first worked well (confirmed gap before coding)
- BUT: Prematurely claimed "Phase 2 complete" - user correctly challenged this
- Benchmark MRR barely changed (0.496 → 0.498) despite adding patterns
- Patterns may be redundant signal - session observations already mention them
- Need ablation testing to prove patterns add value, not just exist

**Remaining Work:**
- 2.7c: Ground truth expansion (20 → 50+ queries)
- 2.7d: Hyperparameter tuning (rrf_k, fetch_multiplier)
- 2c/2.7e: Session MCP tools

### 17:45 - MRR Investigation (Andrew Ng style)

**Root Cause Analysis:**
1. Patterns appear in semantic (#1-4) but NOT in lexical results
2. Lexical oracle only searched `code_fts`, NOT `pattern_fts`
3. Code files with "unix" (std::os::unix) polluted lexical results
4. RRF fusion boosted code (appears in both) over patterns (semantic only)

**Fixes Applied:**
1. Added `pattern_fts` search to `scry_lexical()`
2. Fixed hyphenated terms: quote them for FTS5 ("dependable-rust" not dependable-rust)
3. Removed `.min(1.0)` score cap that made all BM25 scores equal

**Results:**
| Metric | Before | After | Change |
|--------|--------|-------|--------|
| MRR | 0.498 | 0.624 | +25% |
| Recall@5 | 47.5% | 57.5% | +21% |
| Recall@10 | 57.5% | 67.5% | +17% |

**df20 (unix-philosophy):** RR=0.00 → RR=0.17 (now found at position 6)
**df19 (dependable-rust):** Still failing - "module" term matches too many code files

**Key Insight:** Lexical oracle favors high term-frequency matches. Code has "module" everywhere. Patterns need semantic similarity to rank well.


### 17:45 - Update (covering since 17:02)

**Git Activity:**
- Commits this session:        0
- Files changed: 2
- Last commit: 3 hours ago


## Session Classification
- Work Type: pattern-work
- Files Changed:        6
- Commits:        1
- Patterns Modified:        2
- Session Tags: session-20251214-134746-start..session-20251214-134746-end
