# Session: Review Last Session Changes
**ID**: 20251214-175410
**Started**: 2025-12-14T22:54:10Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251214-175410-start
**Starting Commit**: 768203cd14f3a511c48ed51f897c14a54966cc2b

## Previous Session Context
Last session **completed Phase 2.7f** (layer pattern indexing) and fixed critical lexical search bugs. Key accomplishments: (1) Created `src/commands/scrape/layer/mod.rs` to index 25 layer patterns (7 core + 18 surface) with YAML frontmatter parsing, (2) Fixed `scry_lexical()` to search `pattern_fts` table in addition to `code_fts`, (3) Fixed hyphenated terms like "dependable-rust" by quoting them for FTS5. Results: MRR improved from 0.498 → 0.624 (+25%), Recall@5 from 47.5% → 57.5%. Remaining work: ground truth expansion (20 → 50+ queries), hyperparameter tuning, and session MCP tools.

## Goals
- [x] Deep review of project state (Andrew Ng / Amidi style analysis)
- [ ] Update build.md and spec docs
- [ ] Verify pattern_fts results with verbose benchmark

## Activity Log
### 17:54 - Session Start
Session initialized with goal: Review Last Session Changes
Working on branch: patina
Tagged as: session-20251214-175410-start

### 18:00 - Deep Review Complete (PhD ML-Style Analysis)

**Scope:** Reviewed 10+ sessions (Dec 10-14), all core layer docs, build.md, spec-agentic-rag.md, git history, and current implementation structure.

#### Current Benchmark Results (Live)

| Oracle | MRR | Recall@10 | Latency |
|--------|-----|-----------|---------|
| Combined (RRF) | **0.624** | 67.5% | 135ms |
| Lexical only | 0.620 | 62.5% | 2ms |
| Semantic only | 0.201 | 45.0% | 94ms |

#### Core Principles Alignment

| Principle | Status | Evidence |
|-----------|--------|----------|
| dependable-rust | ✅ Strong | `retrieval/` exports only Oracle, QueryEngine, FusedResult |
| unix-philosophy | ✅ Strong | scry → Oracle → QueryEngine → fusion → MCP chain |
| adapter-pattern | ⚠️ Partial | Oracle is strategy pattern (internal), not adapter (external) |

**Key "Do X" Tests:**
- `retrieval/` = "Retrieve relevant knowledge" ✅
- `mcp/` = "Serve MCP protocol over stdio" ✅
- `scrape/layer/` = "Index layer patterns" ✅

#### Session Evolution (Dec 10-14)

| Session | Key Achievement | Ng Principle |
|---------|-----------------|--------------|
| 20251211-201645 | Pivoted from local LLM to parallel+RRF | "Simple beats complex" |
| 20251212-135526 | Built `patina bench`, found code not indexed | "Data > Code" |
| 20251213-083935 | Fixed ground truth format, oracle ablation | "Evaluate rigorously" |
| 20251213-155714 | Fixed lexical (MRR 0→0.436), added --verbose | "Error analysis first" |
| 20251214-134746 | Indexed layer patterns (25 docs) | "Fill data gaps" |

**MRR Evolution:**
```
0.017 → 0.176 → 0.171 → 0.496 → 0.624 (36x improvement)
```

#### Critical Finding: Lexical Dominance Inversion

Lexical (0.620) now nearly matches combined (0.624). The FTS5 fix from 2.7a was highly effective. Semantic (0.201) contributes but doesn't lead.

**This is expected behavior:** Technical queries with exact terms favor lexical. Paraphrased/conceptual queries would favor semantic. Ground truth is biased toward exact match queries.

#### Failing Queries (5/20 at RR=0.00)

| Query | Expected | Root Cause |
|-------|----------|------------|
| df04-semantic-oracle | `oracles/semantic.rs` | CamelCase tokenization |
| df11-scrape-code | `scrape/code/*.rs` | Generic "code" term |
| df17-git-branch-safety | `git/fork.rs` | "git" matches too many |
| df19-dependable-rust | `layer/core/dependable-rust.md` | Generic terms in query |
| df15-mothership | `mothership/*.rs` | Low ranking |

#### Exit Criteria Status

| Criterion | Required | Current | Status |
|-----------|----------|---------|--------|
| All oracles contribute | RRF > individual | 0.624 > 0.620 | ✅ Marginal |
| MRR > 0.3 | 0.3 | 0.624 | ✅ |
| `patina_context` via MCP | Working | Working | ✅ |
| Error analysis tooling | `--verbose` | Working | ✅ |

**Verdict:** 4/4 exit criteria met. Phase 2 core complete.

#### Remaining Phase 2 Work (Enhancement, Not Blockers)

| Task | Status | Impact |
|------|--------|--------|
| 2.7c: Ground truth expansion (20→50+) | ❌ | Statistical confidence |
| 2.7d: Hyperparameter tuning | ❌ | Optimize rrf_k |
| 2c/2.7e: Session MCP tools | ❌ | Dogfooding value |

#### Recommendations

**Immediate:**
1. ✅ Phase 2.7f already committed (verified)
2. Verify pattern_fts results with verbose benchmark

**Short Term:**
- Phase 2.7c: Add 30+ queries (paraphrased/conceptual)
- Investigate pattern retrieval gap (df19)
- Implement session MCP tools

**Medium Term:**
- Phase 2.7d: Hyperparameter sweep with benchmark evidence
- Consider pattern-specific oracle with title/purpose boosting

### 18:30 - Verified pattern_fts Results (Root Cause Found)

**Investigation:** Ran verbose benchmark on df19 (dependable-rust) and df20 (unix-philosophy).

**Finding:** Patterns ARE indexed and FTS5 queries work correctly:
```sql
-- pattern_fts returns "Dependable Rust" as top result for:
-- "dependable-rust" OR "black-box" OR module OR pattern
```

**Root Cause: BM25 Score Scale Mismatch**

Different FTS5 tables produce incompatible score scales:
```
code_fts (8000+ docs):    BM25 = -9.16 → converted to 9.16
pattern_fts (25 docs):    BM25 = -3.83 → converted to 3.83
```

Code results outrank patterns because their absolute BM25 scores are higher (more documents = more negative BM25). This is a **normalization issue** - scores from different tables aren't comparable.

**Options:**
1. **Normalize scores per-table** - divide by table max or use z-scores
2. **Boost pattern results** - multiply pattern scores by scaling factor
3. **Separate pattern oracle** - dedicated oracle for patterns with independent scoring

**Recommendation:** Option 3 (separate oracle) aligns with unix-philosophy - each oracle does one thing well. The lexical oracle searches code symbols; a new pattern oracle searches layer knowledge.

**Action:** Document as Phase 2.7g enhancement, not blocker. Exit criteria still met.

### Files Changed This Session
- `.claude/context/active-session.md` - Deep review and analysis
- `layer/core/build.md` - Updated metrics, exit criteria status
- `layer/surface/build/spec-agentic-rag.md` - Updated status and metrics


### 21:55 - Update (covering since 17:54)

**Git Activity:**
- Commits this session: 2 (docs review + PR merge)
- PR #58 merged to main
- Branch synced: main pulled, patina rebased

**Work Completed:**
1. Deep review of project state (PhD ML-style, Andrew Ng/Amidi analysis)
2. Updated build.md with current metrics and exit criteria status
3. Updated spec-agentic-rag.md with Phase 2 completion status
4. Verified pattern_fts results - found BM25 score scale mismatch
5. Ran pre-CI checks (174 tests pass)
6. Created and merged PR #58

**Key Decisions:**
- Phase 2 exit criteria declared MET (MRR 0.624 > 0.3 target)
- BM25 score mismatch documented as Phase 2.7g enhancement (not blocker)
- Recommended separate pattern oracle for better layer doc retrieval

**Patterns Observed:**
- Lexical dominance inversion: after FTS5 fixes, lexical nearly matches combined
- Different FTS5 tables produce incompatible BM25 scales (doc count affects scores)
- 36x MRR improvement achieved through systematic error analysis


## Session Classification
- Work Type: pattern-work
- Files Changed:        2
- Commits:        3
- Patterns Modified:        2
- Session Tags: session-20251214-175410-start..session-20251214-175410-end
