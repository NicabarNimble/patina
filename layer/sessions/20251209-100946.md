# Session: Fix and Clean Phase 5 Mistakes
**ID**: 20251209-100946
**Started**: 2025-12-09T15:09:46Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251209-100946-start
**Starting Commit**: 46927773b33f801a6212b472948a3914da97230f

## Previous Session Context
Last session (20251209-092145) implemented Phase 5 of the launcher architecture. Completed: first-run detection with ~/.patina/ structure (5a), adapter launch system with frontend detection (5b), `patina launch` and `patina adapter` commands (5c), and layer/rules/ structure (5d). Key refactor: merged `adapter/` module into `adapters/launch.rs` after user caught naming confusion with existing `adapters/`. Outstanding: clippy warnings remain (unused helpers, needless match) - must fix before push.

## Goals
- [x] Review Phase 5 implementation vs spec
- [x] Identify architectural issues
- [x] Redesign launcher architecture (source vs presentation model)
- [x] Document patina branch model (owner vs contrib)
- [x] Update spec-launcher-architecture.md
- [x] Update build.md Phase 5 tasks
- [x] Delete incorrect layer/rules/ directory
- [ ] Implement fixes to code (next session)

## Activity Log
### 10:09 - Session Start
Session initialized with goal: Fix and Clean Phase 5 Mistakes
Working on branch: patina
Tagged as: session-20251209-100946-start

### 10:09-11:30 - Architecture Review & Redesign

**Problems Identified:**
1. `patina launch claude` wrong - should be `patina claude` (launcher implicit)
2. `layer/rules/` wrong location - created confusion about source of truth
3. Dead code: 5 unused helper functions in launch/mod.rs
4. Manifest files over-engineered - enum is simpler and matches philosophy

**Key Architectural Decisions:**

1. **Source vs Presentation Model**
   - `.patina/context.md` = source of truth (committed)
   - `CLAUDE.md`, `.claude/` = presentation (gitignored, generated on launch)
   - Same source generates different frontend presentations

2. **Two-Tier Rules**
   - Global rules: `~/.patina/personas/` (light touch preferences)
   - Project rules: `.patina/context.md` (detailed architecture, patterns)
   - Adapters combine both into frontend-specific format

3. **Patina Branch Model**
   - Always work on `patina` branch, PR to main
   - Owner repos: patina artifacts included in main
   - Contrib repos: CI strips patina artifacts from PRs
   - Branch is the isolation mechanism

4. **Enum vs Manifest**
   - Frontend detection via simple enum (dependable-rust philosophy)
   - No manifest.yaml files needed
   - Templates still live in `~/.patina/adapters/{frontend}/templates/`

**Files Updated:**
- `layer/surface/build/spec-launcher-architecture.md` - Complete rewrite
- `layer/core/build.md` - Phase 5 tasks updated
- Deleted `layer/rules/` directory

**Next Steps (Implementation):**
- Remove `Commands::Launch` subcommand, make launcher default
- Update CLI parsing for `patina [frontend]`
- Create `.patina/context.md` template
- Add gitignore entries for presentation files
- Clean up dead code


### 11:16 - Update (covering since 10:09)

**Git Activity:**
- Commits this session: 0
- Files changed: 3 (build.md, spec-launcher-architecture.md, deleted layer/rules/)
- Last commit: 69 minutes ago

**Work Completed:**
- Deep architecture review comparing spec vs implementation
- Identified 4 major issues with Phase 5 implementation
- Rewrote spec-launcher-architecture.md with new design (572 lines)
- Updated build.md Phase 5 tasks to match new design
- Deleted incorrect layer/rules/ directory (was wrong source of truth location)
- Reviewed existing codebase: workspace/, adapters/, commands/launch/

**Key Decisions:**
1. Source vs Presentation model: `.patina/context.md` committed, `CLAUDE.md` gitignored
2. Patina branch model: always work on `patina` branch, PR to main, CI strips for contrib
3. Enum over manifest: Frontend detection via simple enum, not YAML manifests
4. Two-tier rules: Global (persona, light) + Project (context.md, detailed)

**Challenges Faced:**
- Initial confusion about layer/rules/ vs CLAUDE.md as source of truth
- Discovered existing code has more than expected: LLMAdapter trait, templates in resources/
- Need to reconcile "presentation gitignored" with this repo already having CLAUDE.md committed

**Patterns Observed:**
- Slowing down to review before coding catches architectural issues early
- The spec was mostly right, implementation deviated from it
- Existing code is more complete than session notes indicated (workspace, launch flow work)

**Open Questions (need user input):**
1. Where should context.md live? (.patina/context.md vs layer/context.md)
2. Transition plan for this repo's existing CLAUDE.md?
3. When to copy templates to ~/.patina/adapters/?

---

## Complete Architecture Summary (For Next Session)

### The Core Insight
`patina` is the launcher (like `code .` for VS Code). Source of truth is committed, presentation is generated.

### Command Structure (Target)
```bash
patina              # Default frontend, current dir
patina claude       # Explicit frontend (NOT patina launch claude)
patina gemini       # Different frontend
patina --yolo gemini  # YOLO container
patina serve        # Mothership daemon
patina adapter list # Show frontends
```

### Source vs Presentation Model
```
COMMITTED (source of truth):
├── .patina/context.md       # Project rules
├── .patina/config.toml      # Project config (mode: owner/contrib)
├── layer/                   # Knowledge (sessions, patterns)

GITIGNORED (generated on launch):
├── CLAUDE.md                # Generated from context.md + persona
├── .claude/                 # Copied from templates
├── GEMINI.md
├── .gemini/
```

### Two-Tier Rules
- **Global** (`~/.patina/personas/`): Light preferences, cross-project
- **Project** (`.patina/context.md`): Detailed architecture, patterns, conventions

### Branch Model
- Always work on `patina` branch
- PR to main
- **Owner repos**: patina artifacts go to main
- **Contrib repos**: CI strips .patina/, layer/ from PRs

### What Already Exists (Keep/Reuse)
| Component | Location | Notes |
|-----------|----------|-------|
| GlobalConfig | `src/workspace/internal.rs` | Has workspace, frontend, serve sections |
| First-run setup | `workspace::setup()` | Creates ~/.patina/, detects CLIs |
| Frontend enum | `src/adapters/launch.rs` | Claude, Gemini, Codex with detection |
| Launch flow | `src/commands/launch/internal.rs` | Mothership check, project check, exec |
| AdapterCommands | `src/main.rs:448` | List, Default, Check |
| LLMAdapter trait | `src/adapters/mod.rs` | For init-time scaffolding |
| Claude templates | `resources/claude/.claude/` | Full structure with scripts, commands |

### What Needs to Change
| Change | File(s) | Details |
|--------|---------|---------|
| Remove Launch subcommand | `src/main.rs` | Make launcher implicit default behavior |
| CLI parsing | `src/main.rs` | Frontend names vs subcommands logic |
| Add context.md | `.patina/context.md` | New file, source of truth |
| Generate presentation | `src/commands/launch/internal.rs` | Read context.md → generate CLAUDE.md |
| Update gitignore | `.gitignore` | Add CLAUDE.md, .claude/, GEMINI.md, etc. |
| Clean dead code | `src/commands/launch/mod.rs` | 5 unused helper functions |

### CLI Parsing Logic (Implementation)
```rust
// Pseudocode for main.rs
match first_arg {
    "serve" | "init" | "adapter" | "scry" | ... => run_subcommand(),
    Some(arg) if is_path(arg) => launch(path=arg, frontend=next_arg),
    Some(arg) if is_frontend(arg) => launch(path=".", frontend=arg),
    None => launch(path=".", frontend=default),
}
```

### Files Updated This Session
- `layer/surface/build/spec-launcher-architecture.md` - Complete rewrite with new design
- `layer/core/build.md` - Phase 5 tasks updated
- Deleted `layer/rules/` (context.md, patterns.md, tools.md)

### Clippy Warnings Still Outstanding
```
src/commands/launch/mod.rs:51  - launch_default() unused
src/commands/launch/mod.rs:56  - launch_frontend() unused
src/commands/launch/mod.rs:64  - launch_project() unused
src/commands/launch/mod.rs:72  - is_mothership_running() unused
src/commands/launch/mod.rs:77  - start_mothership() unused
src/commands/launch/internal.rs:194 - needless match
```

### Key Specs to Read
- `layer/surface/build/spec-launcher-architecture.md` - THE spec (just updated)
- `layer/core/build.md` - Phase 5 tasks
- `layer/core/dependable-rust.md` - Module pattern philosophy
- `layer/core/adapter-pattern.md` - Trait-based adapters

### Next Session Action Items
1. Decide: Where does context.md live?
2. Decide: Transition plan for existing CLAUDE.md
3. Implement: Remove Commands::Launch, make launcher default
4. Implement: Add .patina/context.md generation
5. Implement: Presentation file generation on launch
6. Clean: Remove dead code, fix clippy warnings
7. Test: `patina claude` opens Claude Code


## Session Classification
- Work Type: pattern-work
- Files Changed:        6
- Commits:        1
- Patterns Modified:        6
- Session Tags: session-20251209-100946-start..session-20251209-100946-end
