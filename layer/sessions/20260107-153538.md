# Session: ref-repo-semantic
**ID**: 20260107-153538
**Started**: 2026-01-07T20:35:38Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20260107-153538-start
**Starting Commit**: 7ef07cf562774cf42bdedc1a571b9e2db1bb7f26

## Previous Session Context
Last session (20260107-143753) fixed the recipe creation gap where `patina repo add` wasn't auto-enabling semantic even when commits exist. After the fix, rebuilt all 13 ref repos and got 11/13 with semantic indexes (up from 4/13). SDL and livestore still fail due to ONNX token length error (> 512 tokens) affecting large functions - this is the next issue to address.

## Goals
- [x] Fix ONNX token length error for SDL and livestore repos
- [x] Implement truncation/chunking strategy for large functions

## Activity Log
### 15:35 - Session Start
Session initialized with goal: ref-repo-semantic
Working on branch: patina
Tagged as: session-20260107-153538-start


### 18:21 - Note [patina@377df3ad]
Ng/Sutton principle validated: 6 lines of truncation config fixed ONNX token limit issue. Truncation preserves semantic quality (0.85-0.92 scores). Historical context in layer/sessions revealed ONNX was chosen for cross-platform vector consistency. Future path to Qwen3-0.6B (8192 tokens) already documented in spec.

### 20:37 - Update (covering since 15:35)

**Git Activity:**
- Commits this session: 5
- Files changed: 4
- Last commit: 65 minutes ago

**Work Completed:**
- Fixed ONNX token length error by configuring tokenizer truncation at 512 tokens
- SDL now has 12,137 semantic vectors, livestore has 2,984
- All 13/13 ref repos now have semantic indexes (was 11/13)
- Verified semantic quality on SDL/livestore (scores 0.85-0.92)
- Fixed CI issues: added Cargo.lock for reproducible builds, gated log_debug to macOS
- Merged PR #70 to main

**Key Decisions:**
- Chose truncation over chunking (Ng/Sutton principle: simplest fix that works)
- Added Cargo.lock to git (was ignored, causing CI to pull incompatible ort rc.11)

**Commits:**
```
bd3018f0 fix(embeddings): truncate tokens to 512 for ONNX model limit
377df3ad docs: mark Phase 3 complete - 13/13 repos with semantic indexes
2774be89 style: format commits.rs
d123f88c chore: track Cargo.lock for reproducible CI builds
c5cbbe64 fix: gate log_debug to macos only (dead code on Linux CI)
```

**Learnings:**
- Truncation preserves semantic quality because function signatures and early logic are most meaningful
- Historical context in layer/sessions revealed ONNX chosen for cross-platform vector consistency
- Future path: Qwen3-0.6B (8192 tokens) already documented in spec when longer context needed


## Session Classification
- Work Type: pattern-work
- Files Changed:        7
- Commits:        5
- Patterns Modified:        2
- Session Tags: session-20260107-153538-start..session-20260107-153538-end
