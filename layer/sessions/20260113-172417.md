# Session: spec-adapter-selection
**ID**: 20260113-172417
**Started**: 2026-01-13T22:24:17Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20260113-172417-start
**Starting Commit**: aec0cf99d18201be2ab0080f9def3e400c7c0977

## Previous Session Context
Last session did a deep dive into launch/init/adapter architecture and drafted the adapter selection spec (`layer/surface/build/spec-adapter-selection.md`). Key work: defined two flows (explicit `--adapter=X` vs implicit prompting), designed `select_adapter()` function signature, and discovered/fixed OpenCode being partially implemented but not wired into `adapters/launch.rs`. Four commits shipped, spec ready for implementation.

## Goals
- [x] spec-adapter-selection

## Activity Log
### 17:24 - Session Start
Session initialized with goal: spec-adapter-selection
Working on branch: patina
Tagged as: session-20260113-172417-start


### 18:54 - Update (covering since 17:24)

**Git Activity:**
- Commits this session: 1
- Files changed: 4 (src/adapters/launch.rs, src/main.rs, spec-adapter-selection.md, spec-remove-codex.md)
- Last commit: 38 seconds ago

**Work Completed:**
1. **Drafted spec-remove-codex.md** - Initial version was too shallow (just a deletion checklist)
2. **Revised spec with core values anchoring** - Added sections for Adapter Pattern, Unix Philosophy, Dependable Rust with quotes from layer/core docs
3. **Defined Adapter vs Agent distinction** - Table showing relationship, context, and interface differences
4. **Implemented Codex removal** - Removed from Adapter enum, ADAPTERS const, 6 match arms, tests in launch.rs; replaced Codex with OpenCode in main.rs Llm enum
5. **Updated spec-adapter-selection.md** - Removed all Codex references from code examples and error messages

**Key Decisions:**
- Codex is an agent (spawned BY adapters) not an adapter (launched WITH patina) - conceptually different layer
- Replaced Codex with OpenCode in main.rs Llm enum to align with the 3-adapter goal
- Kept Local in Llm enum (different purpose, not part of adapter discussion)
- Clean break per Jon Gjengset - no deprecated aliases or placeholder stubs

**Patterns Observed:**
- Spec quality matters: initial "just delete it" spec lacked the reasoning that makes specs useful for future reference
- Core values docs (layer/core/*.md) provide ready-made justification for decisions - quote them
- Session context gathering (reading recent sessions, core patterns) before spec revision caught design issues

**Commits:**
- `454cb71f` refactor(adapters): remove Codex from adapter system


### 19:54 - Update (covering since 18:54)

**Git Activity:**
- Commits this session: 5 total
- Last commit: 21 minutes ago

**Work Completed:**
1. **Implemented spec-adapter-selection** - Added `select_adapter()` function to adapters/launch.rs with tests for 0, 1, and 2+ adapter cases
2. **Updated prompt_are_you_lost()** - New signature returns `Option<String>`, accepts `explicit_adapter: Option<&str>`, calls `select_adapter()` for implicit flow
3. **Implemented two-flow launch** - Flow A (explicit `--adapter=X`) validates early and skips selection; Flow B (no flag) defers to adapter selection prompt
4. **Fixed project default behavior** - Selected adapter at init now becomes project default; existing projects use project default instead of global default
5. **Manual testing verified** - Full flow works: select Gemini at init, re-run patina, launches Gemini automatically

**Key Decisions:**
- Priority order: `--adapter` flag > project default > global default
- Set project default during init (Step 3 after adapter add)
- `cargo install` needs `--locked` flag due to i18n-embed dependency issue with newer Rust

**Commits:**
- `e262fb97` feat(adapters): add select_adapter() function
- `53b5f2ff` feat(launch): implement two-flow adapter selection
- `b1674ffc` docs: mark spec-adapter-selection as implemented
- `0b64e16a` fix(launch): use project default adapter for existing projects

**Challenges:**
- `cargo install` without `--locked` hit i18n-embed lifetime error - fixed by using existing Cargo.lock
- Initial adapter add didn't set project default (condition checked `is_empty()` which was never true) - fixed by explicitly setting default in initialize_project()


## Session Classification
- Work Type: pattern-work
- Files Changed:        5
- Commits:        5
- Patterns Modified:        2
- Session Tags: session-20260113-172417-start..session-20260113-172417-end
