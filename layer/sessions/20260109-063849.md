# Session: layer/surface detail design and plan
**ID**: 20260109-063849
**Started**: 2026-01-09T11:38:49Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20260109-063849-start
**Starting Commit**: 6789346e67e6040498b0df3cfd6a350daca8ed4f

## Previous Session Context
Last session was deep design exploration of `layer/surface/`. Key accomplishment: rewrote `spec-surface-layer.md` with refined understanding that surface is the **distillation layer above** scry/assay/oxidize (not parallel to eventlog). Established surface as the federation interface - other projects query surface, not raw eventlog/embeddings. Defined the cycle: Git → eventlog → tools → SURFACE → Git. Open item: implement `patina surface` command to generate surface content from scry/assay queries.

## Goals
- [ ] layer/surface detail design and plan

## Activity Log
### 06:38 - Session Start
Session initialized with goal: layer/surface detail design and plan
Working on branch: patina
Tagged as: session-20260109-063849-start


### 12:25 - Update (covering since 06:38)

**Git Activity:**
- Commits this session: 0
- Files changed: 5
- Last commit: 24 hours ago

**Work Completed:**
- Deep dive into surface layer design with real-world scenario walkthrough
- Traced complete data flow: Git → scrape → eventlog → oxidize → embeddings → scry/assay
- Audited MCP server code - confirmed scry/assay/context already support `repo` param for ref repo queries
- Reviewed persona command as template for surface write operations (LiveStore pattern)
- Identified gap: current layer/surface/ contains 37 manually authored docs (tech debt), will be replaced with atomic nodes

**Discussion Context:**
- User clarified surface role via "Four Things" model: Sessions (talking), Commits (doing), Surface (understanding), Persona (craftsman)
- Walked through real scenario: "build 1-bit doom clone in dojo engine" - what should happen?
- Discovered MCP query interface already supports ref repos (scry with repo: "dojo" works)
- Identified that surface transfer is NOT via patina init --surface-from, but via LLM/MCP at runtime

**Key Decisions:**
1. Current layer/surface/ docs are tech debt - will be replaced entirely with new atomic node format
2. Surface population has three options: deterministic rules, LLM extraction, or hybrid
3. Instinct: Start with deterministic (assay components), add hybrid for decisions/patterns later
4. Follow persona pattern: add() → events → materialize() → queryable

**Challenges Faced:**
- Initial confusion about oxidize role (it's indexing/preparation, not query)
- Diagram arrows were pointing wrong direction - fixed to show data flow bottom-up
- Clarified eventlog is NOT immutable log - it's derived state rebuilt by scrape (git IS the immutable log)

**Patterns Observed:**
1. LiveStore pattern working well: git = events, eventlog = derived state, scrape = replay
2. Persona provides template for surface write operations
3. MCP already has query infrastructure - just needs write tool added
4. Atomic nodes with wikilinks better for RAG than chunked documents (retrieval granularity, explicit graph)

**What Spec Needs:**
- Surface node schema (Rust struct)
- `surface add` command with guardrails
- `surface seed` command (import from query results)
- MCP tool: `surface_add`
- Origin tracking (internal/imported/persona)


### 16:09 - Update (covering since 12:25)

**Git Activity:**
- Commits this session: 0
- Files changed: 5
- Last commit: 28 hours ago

**Work Completed:**
- Explored surface population options (deterministic rules vs LLM extraction vs hybrid)
- Identified that raw scry results are noisy - LLM synthesis adds the value
- Researched local LLM options for surface synthesis (FunctionGemma, OLMo 3, Phi-3)
- Deep dive into Rust + Apple Silicon inference options (llama.cpp, Candle, mlx-rs, ort)
- Key discovery: patina already uses `ort` crate for embeddings - can reuse for LLM inference
- Found Gemma ONNX models available (270M at ~150MB, 1B at ~600MB)
- Designed "model cartridge" system for pluggable ONNX models

**Discussion Context:**
- User asked about local LLM for surface synthesis - is it wasting frontier LLM power?
- Answer: No - use frontier for reasoning/judgment, local for routine transformation
- Explored model sizes: FunctionGemma 2B (~1.4GB), OLMo 3 1B (~0.6GB), Gemma 270M (~150MB)
- User asked about ONNX compatibility - discovered Gemma ONNX models exist on HuggingFace
- "Nintendo cartridge" mental model emerged - swap models like game carts

**Key Decisions:**
1. Local LLM for surface synthesis is architecturally sound (right tool for job)
2. Use `ort` (already in patina) rather than adding new inference crate
3. Gemma 3 270M ONNX is smallest option (~150MB) - try this first
4. Model cartridge system: manifest.json + model.onnx + tokenizer.json per model
5. Single ort runtime, multiple pluggable cartridges

**Challenges Faced:**
- Raw scry results are snippets/scores - not suitable for direct surfacing
- LLM synthesis needed for quality, but introduces non-determinism
- Resolved: local LLM provides synthesis quality at low cost, deterministic format via schema

**Patterns Observed:**
1. "Cartridge" pattern for pluggable models - manifest + artifacts, hot-swappable
2. Reuse existing infrastructure (ort) rather than adding dependencies
3. Frontier LLM for judgment, local LLM for transformation - separation of concerns
4. Smallest model that works (270M) before scaling up

**Architecture Insight:**
```
┌─────────────────┐
│  Frontier LLM   │  ← User interaction, judgment
└────────┬────────┘
         │ calls scry/assay
         ▼
┌─────────────────┐
│  Query Results  │  ← Raw, noisy
└────────┬────────┘
         │ local synthesis
         ▼
┌─────────────────┐
│  Local LLM      │  ← Gemma 270M via ort
│  (cartridge)    │
└────────┬────────┘
         │ structured output
         ▼
┌─────────────────┐
│  Surface Node   │  ← Clean, formatted, linked
└─────────────────┘
```


### 16:11 - Session End

**Final summary - no new work since 16:09 update.**

**Session Outcomes:**
1. Clarified surface layer architecture and its role in the stack
2. Identified path forward: local LLM (Gemma 270M ONNX) for surface synthesis via existing ort crate
3. Designed "model cartridge" pattern for pluggable models
4. Identified spec updates needed before implementation

**Next Steps:**
- Update spec-surface-layer.md with cartridge system and local LLM synthesis
- Prototype ort-based text generation with Gemma 270M ONNX
- Implement `patina model` command for cartridge management


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20260109-063849-start..session-20260109-063849-end
