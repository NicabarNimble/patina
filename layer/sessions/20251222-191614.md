# Session: code_fts
**ID**: 20251222-191614
**Started**: 2025-12-23T00:16:14Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251222-191614-start
**Starting Commit**: 6dd86b0ceae8b0e0348b818d3e5559edba78745a

## Previous Session Context
The previous session investigated cross-project knowledge architecture and discovered a critical **code_fts duplication bug**: every code symbol is inserted 8 times (4 as code.symbol, 4 as code.function). This explains why code results dominate over layer documentation in scry output - the RRF fusion algorithm correctly sums scores, but duplicated entries artificially boost code rankings. Two specs were created (spec-persona-fusion.md, spec-secrets-boundary.md) but the root cause fix was deferred.

## Goals
- [ ] Fix code_fts duplication bug in scrape
- [ ] Verify layer docs surface properly after fix

## Activity Log
### 19:16 - Session Start
Session initialized with goal: code_fts
Working on branch: patina
Tagged as: session-20251222-191614-start

---

## Deep Dive: Git Archaeology of the Duplication Bug

### The Problem Restated

Layer docs (spec-pipeline.md) ranked #1 in BOTH semantic AND lexical oracles, but ranked #5 in final fused output. Code symbols ranked #1 in fusion despite losing both individual oracles.

**Root cause:** RRF fusion sums reciprocal ranks. A symbol appearing 8 times accumulates 8 rank contributions:
- spec-pipeline.md: ranks #1, #1 → score = 1/61 + 1/61 = 0.033
- code symbol with 8 entries → score ≈ 0.115

The math is correct. The data is duplicated.

### Tracing the Data Flow

**Current architecture:**
1. Language processor finds a function
2. Calls `data.add_function(FunctionFact{...})` → `code.function` event + `function_facts` table
3. Calls `data.add_symbol(CodeSymbol{...})` → `code.symbol` event + `code_search` table
4. `populate_fts5()` pulls ALL `code.%` events into FTS5 index
5. Same function appears twice in code_fts → duplicate RRF contributions

**Key finding:** `code_search` table is NEVER QUERIED by anything. `function_facts` is the real source of truth (used by assay, oxidize, scry, MCP).

### Git History Timeline

#### August 2025 - Original Architecture (`b7c1ddf2`)
```
feat: implement fingerprint-based semantic indexing for ultra-fast code search

- Add 16-byte fingerprint structure (pattern, imports, complexity, flags)
- Leverage DuckDB columnar storage for SIMD-optimized queries
- Replace vector embeddings with structural hashing (9KB vs 30MB)
```

Original design had TWO tables for different purposes:
- `code_fingerprints` - 16-byte fingerprints for semantic similarity
- `code_search` - path/name/signature for text-based search

Functions written to BOTH because they served different query patterns. This was intentional.

#### September 2025 - ExtractedData Refactor (`5bce30c1`)
```
refactor: Rust processor returns ExtractedData structs instead of SQL strings

- Created ExtractedData struct to hold all extracted symbols
- Replaced Rust processor to return typed structs
- Eliminated SQL string generation in Rust processor
```

Diff shows:
```rust
// Old SQL version comment:
"Also insert into code_search"

// New struct version:
data.add_function(function);
// Add to code search
data.add_symbol(symbol);
```

The dual-write was PRESERVED because "don't break existing behavior." The session notes say "All 11 language processors untouched" - the pattern was inherited, not designed.

#### November 2025 - Unified Eventlog (`73f7a227`)
```
feat(scrape): complete Phase 1 unified eventlog implementation

Completes code scraper refactor to unified patina.db with dual-write
pattern (eventlog + materialized views).
```

Dual-write evolved:
- Old: `function_facts` + `code_search`
- New: `eventlog (code.function)` + `function_facts` + `eventlog (code.symbol)` + `code_search`

Now FOUR writes for each function.

#### November 2025 - FTS5 Added (`44a43c5c`)
```
feat(scrape): add FTS5 lexical index for exact-match search

- Indexes 9620 symbols with porter stemming
- Enables exact-match queries like 'find spawn_entity'
```

The FTS5 population query:
```sql
WHERE event_type LIKE 'code.%'
```

This pulls from eventlog which now has BOTH `code.symbol` AND `code.function` events for the same AST node.

**3 days after the dual-write commit. The FTS5 author didn't account for the duplication.**

### The Verdict

**`code_search` was designed for text search in a fingerprint-based architecture that no longer exists.**

When that architecture was replaced:
- Fingerprints → Embeddings (oxidize)
- Text search → FTS5 (code_fts)

`code_search` became orphaned. But:
- The writes to it continued
- The `code.symbol` events that fed it now pollute FTS5
- Nobody realized the old architecture was gone

**This is vestigial code from an abandoned architecture. The fix is cleanup, not a design tradeoff.**

### Fix Options Analysis (Andrew Ng Style)

#### Option 1: Fix at Extraction
Remove `add_symbol()` calls for things that have richer fact types (functions, types).

- **Fixes problem:** Yes
- **Risk:** 50+ call sites across 10 language files
- **Verdict:** Right long-term fix, but invasive

#### Option 2: Fix at FTS Population
Change SQL to exclude `code.symbol` or dedupe:
```sql
WHERE event_type LIKE 'code.%' AND event_type != 'code.symbol'
```

- **Fixes problem:** Yes
- **Risk:** Low - one SQL query change
- **Verdict:** Pragmatic, surgical, ship first

#### Option 3: Fix at Fusion
Dedupe in RRF fusion logic - don't let same doc_id accumulate.

- **Fixes problem:** Yes
- **Risk:** Adds complexity to fusion, data still duplicated
- **Verdict:** Only if can't touch extraction or FTS

### Recommendation

**Short term:** Option 2 - filter at FTS population. Surgical, low-risk, verifiable immediately.

**Long term:** Option 1 - clean up extraction. Remove vestigial symbol writes for functions/types.

### Key Decisions Made This Session

1. The dual-write is NOT intentional design for current architecture - it's vestigial
2. `code_search` table serves no purpose - nothing queries it
3. Fix should target data quality, not algorithm complexity
4. "Data quality > model complexity" (Andrew Ng principle)

---

## BEFORE Metrics (Pre-Fix Baseline)

### Benchmark Results
```
Query set: patina-core-retrieval (8 queries)
MRR:        0.604
Recall@5:   42.7%
Recall@10:  42.7%
Latency p50: 155ms
```

### Event Counts
```
code.symbol:   9,118
code.function: 4,823
code.struct:   766
(total code_fts entries: 20,059)
```

### Sharp Test: "pipeline architecture" (Hybrid Mode)
```
[1] analyze_architecture (score: 0.124) (lex #8)        ← CODE WINS
[2] spec-pipeline (score: 0.031) (sem #1 | lex #9)      ← DOC LOSES
```

**Bug confirmed:** Code function with only lex #8 beats doc with sem #1 + lex #9.

---

## AFTER Metrics (Post-Fix)

### Fix Applied (src/commands/scrape/database.rs:80-100)
1. Filter: `AND event_type != 'code.symbol'`
2. Dedupe: `GROUP BY source_id, event_type`

### Results
```
FTS5 entries: 20,059 → 2,770 (86% reduction)

Benchmark (eval/retrieval-queryset.json):
  MRR:        0.604 → 0.338 (regression)
  Recall@5:   42.7% → 17.7% (regression)

Sharp Test "pipeline architecture" --hybrid:
  BEFORE: [1] analyze_architecture (0.124) ← code wins
  AFTER:  [1] spec-pipeline (0.033) ← doc wins! ✓
```

### Why Benchmark Regressed
- Benchmark expects file-level: `./src/commands/assay/mod.rs`
- FTS5 now returns symbol-level: `./src/commands/assay/mod.rs::AssayOptions`
- Content IS found (90 entries for assay/mod.rs), just different doc_id format

### Decision Point for Next Session
1. **Keep fix** - Update benchmark ground truth to match new format
2. **Revert** - Accept layer docs don't surface
3. **Hybrid** - Re-add symbol events but dedupe against function events

---

## Key Files for Future Reference

| File | Purpose |
|------|---------|
| `src/commands/scrape/database.rs:64-100` | populate_fts5() - THE FIX IS HERE |
| `src/commands/scrape/code/database.rs:260-302` | insert_symbols() - writes code.symbol events |
| `src/commands/scrape/code/languages/rust.rs:176-193` | Dual-write: add_function + add_symbol |
| `layer/surface/build/spec-fts-deduplication.md` | Full spec with context |
| `eval/retrieval-queryset.json` | Benchmark ground truth (needs update?) |

### Key Commits
- `b7c1ddf2` - Original code_search design (Aug 2025)
- `5bce30c1` - ExtractedData refactor preserved dual-write (Sep 2025)
- `73f7a227` - Eventlog dual-write added (Nov 2025)
- `44a43c5c` - FTS5 added without dedup awareness (Nov 2025)

### Current State - RESOLVED
- Fix committed: `ef6f59c5`
- Sharp test passes (layer docs surface)
- MRR: 0.604 → 0.433 (acceptable tradeoff for layer doc visibility)
- Phase 2 cleanup logged: https://github.com/NicabarNimble/patina/issues/63


## Session Classification
- Work Type: pattern-work
- Files Changed:        7
- Commits:        2
- Patterns Modified:        6
- Session Tags: session-20251222-191614-start..session-20251222-191614-end
