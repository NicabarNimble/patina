# Session: build.md review recent phases
**ID**: 20251223-100747
**Started**: 2025-12-23T15:07:47Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251223-100747-start
**Starting Commit**: cec8b50a96f2bf54ad5c0c8be17e20743a82d31a

## Previous Session Context
Completed **Phase 3: Feedback Logging** for Observable Scry. Implemented query ID generation, CLI commands (`scry open/copy/feedback`), MCP `use` mode callback, and SQL views for feedback analysis. Key insight: user caught proposed spec deviations early - "Build what's specified, then measure" (Andrew Ng principle). All changes passed CI checks and were committed.

## Goals
- [x] build.md review recent phases
- [x] Andrew Ng-style audit of spec vs implementation
- [x] Fix data quality issues found during audit
- [x] Document gaps in spec-work-deferred.md
- [x] Create lab automation spec

## Activity Log
### 10:07 - Session Start
Session initialized with goal: build.md review recent phases
Working on branch: patina
Tagged as: session-20251223-100747-start

### 10:30 - Spec vs Reality Audit
Reviewed build.md, spec-observable-scry.md, and git history.

**Finding 1:** Phase 3 was complete but docs said Phase 2.
**Finding 2:** Documentation drift - code ahead of specs.

### 11:00 - Data Quality Investigation
Ran scry queries, found session docs ranking above code.

**Root causes identified:**
1. Stale embeddings - oxidize hadn't been run
2. Doc_id format mismatch - lexical used `path::name:name`, semantic used `path:name`

### 11:30 - Fixes Applied
**Commit 646f0f8a:** fix(scry): normalize doc_id format for proper RRF fusion
- Lexical: use file_path directly (was doubling name)
- Semantic: use `::` separator to match eventlog format

**Result:** Same symbol now merges correctly across oracles.

### 12:00 - Lab Tools Discovery
Ran ablation testing with `patina bench retrieval --oracle`:

| Oracle | MRR | R@5 | R@10 |
|--------|-----|-----|------|
| Semantic only | 0.201 | 40% | 80% |
| Lexical only | 0.422 | 60% | 80% |
| All (fusion) | 0.442 | 80% | 100% |

**Insight:** Semantic is the bottleneck. Lexical does heavy lifting.

### 12:30 - Documentation Updates
**Commit 281f4813:** docs: mark Observable Scry Phase 3 complete, document gaps

Updated:
- build.md: Phase 3 complete
- spec-observable-scry.md: Phase 3 tasks marked done
- spec-work-deferred.md: Added Observable Scry gaps section
  - Feedback capture in LLM workflow
  - Query intent routing
  - Cross-repo validation
  - Lab query set

### 13:00 - Lab Automation Spec
Created spec-lab-automation.md with:
- Model A/B testing (`lab compare-models`)
- Hyperparameter sweep (`lab sweep`)
- Benchmark history (`bench --save`, `lab history`)
- Error categorization (`bench --categorize`)

Baseline metrics established for future improvement tracking.

## Key Insights

1. **Andrew Ng principle applied:** "Your retrieval is returning noise above signal. Fix the data or the ranking before adding more features."

2. **Doc_id consistency matters:** RRF can't merge results with different ID formats. Normalized to eventlog format (`path::name`).

3. **Ablation reveals bottlenecks:** Semantic MRR 0.201 vs Lexical 0.422 - semantic needs work.

4. **Lab tools exist but need automation:** Manual model comparison is too slow for iteration.

## Commits This Session
- `646f0f8a` fix(scry): normalize doc_id format for proper RRF fusion
- `281f4813` docs: mark Observable Scry Phase 3 complete, document gaps
- `48d2b2f9` docs: add lab automation spec with baseline metrics

## Files Created
- `layer/surface/build/spec-lab-automation.md` - Lab automation spec
- `layer/lab/queries.json` - Initial query set (5 queries)

### 13:43 - Final Update

**Git Activity:**
- Commits this session: 3
- Files changed: 7 total across commits
- All changes committed, clean working tree

**Work Completed:**
- Andrew Ng-style spec vs implementation audit
- Fixed doc_id format mismatch (critical RRF bug)
- Established baseline metrics via ablation testing
- Documented 4 gaps in Observable Scry
- Created lab automation spec for future iteration

**Session Summary:**
Productive audit session. Found and fixed a real bug (doc_id mismatch preventing RRF merge). Established baseline metrics showing semantic oracle is the bottleneck. Created roadmap for lab automation to enable faster iteration.


## Session Classification
- Work Type: pattern-work
- Files Changed:        6
- Commits:        3
- Patterns Modified:        5
- Session Tags: session-20251223-100747-start..session-20251223-100747-end
