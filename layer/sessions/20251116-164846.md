# Session: patina-llm-driven-neuro-symbolic-knowledge-system
**ID**: 20251116-164846
**Started**: 2025-11-16T21:48:46Z
**LLM**: claude
**Git Branch**: neuro-symbolic-knowledge-system
**Session Tag**: session-20251116-164846-start
**Starting Commit**: 1fd13ceee0930b7a5ebabd35f7a437c904dfb6fa

## Previous Session Context
Standardized core pattern documentation by deleting redundant pattern-selection-framework.md and expanding three core patterns (dependable-rust, unix-philosophy, adapter-pattern) with comprehensive examples and strategies. Removed arbitrary 150-line rule in favor of principle-based approach focusing on stable interfaces. Validated all patterns align with Patina's neuro-symbolic vision and match actual codebase usage (13% → 100% pattern adoption by focusing on where patterns actually fit).

## Goals
- [ ] patina-llm-driven-neuro-symbolic-knowledge-system

## Activity Log
### 16:48 - Session Start
Session initialized with goal: patina-llm-driven-neuro-symbolic-knowledge-system
Working on branch: neuro-symbolic-knowledge-system
Tagged as: session-20251116-164846-start


### 19:33 - Update (covering since 16:48)

**Git Activity:**
- Commits this session:        2
- Files changed: 5
- Last commit: 7 minutes ago

**Work Completed:**

1. **Implemented Asymmetric Embedding Support** (Commit: 1e3f9d3)
   - Extended EmbeddingEngine trait with embed_query() and embed_passage() methods
   - Added query_prefix and passage_prefix fields to ModelDefinition
   - Updated OnnxEmbedder to apply model-specific prefixes before tokenization
   - Updated all call sites to distinguish queries (searches) from passages (storage)
   - Configured BGE and E5 models in registry with prefix requirements

2. **Added Dynamic Dimension and Model Name Support** (Commit: 795e64e)
   - Extended OnnxEmbedder to accept dimension parameter (384 or 768)
   - Added open_with_dimension() to ObservationStorage for USearch index creation
   - Added model_name field to track actual loaded model
   - Updated SemanticSearch to propagate dimension from embedder to storage
   - Fixed model name display in output (was hardcoded to "all-MiniLM-L6-v2 (ONNX)")

3. **Validated Model Abstraction Across 4 Models**
   - Downloaded and tested: all-minilm-l6-v2, bge-small-en-v1.5, bge-base-en-v1.5, e5-base-v2
   - Tested 3 prefix patterns: none (symmetric), query-only (BGE), dual (E5)
   - Tested 2 dimensions: 384-dim (small models) and 768-dim (base models)
   - Validated seamless model switching via config file

**Key Decisions:**

1. **Backward Compatible Design**
   - embed_query/embed_passage have default implementations calling embed()
   - Symmetric models (all-MiniLM) work without code changes
   - open() method defaults to 384 dimensions for backward compatibility

2. **Dimension from Model Definition**
   - ObservationStorage reads dimension from embedder, not hardcoded
   - USearch index created with correct dimension on first open
   - Prevents "vector length mismatch" errors when switching models

3. **Prefix Application at Tokenization**
   - Prefixes applied before tokenization, not after
   - Ensures model sees correct input format
   - BGE: "Represent this sentence for searching relevant passages: {query}"
   - E5: "query: {query}" for searches, "passage: {text}" for storage

4. **Test Multiple Models to Validate Abstraction**
   - User requested "flush out" the abstraction by testing edge cases
   - Tested 4 models covering all combinations: 384/768 dims × none/query/dual prefixes
   - Found dimension bug, fixed it, validated fix across all models

**Challenges Faced:**

1. **BGE Models Failed Without Query Prefix**
   - Problem: Query 2 returned 0 results with bge-small-en-v1.5
   - Root cause: BGE requires "Represent this sentence..." prefix for queries
   - Solution: Implemented embed_query/embed_passage distinction
   - Result: Query 2 fixed (0.000 → 0.633 similarity)

2. **768-dim Models Failed on Vector Length Mismatch**
   - Problem: bge-base-en-v1.5 crashed with "Vector length must match index dimensionality"
   - Root cause: ObservationStorage hardcoded to 384 dimensions
   - Solution: Added dimension parameter, propagated from embedder
   - Result: All 768-dim models work seamlessly

3. **Model Name Display Always Showed all-MiniLM**
   - Problem: Confusing which model is actually loaded
   - Root cause: model_name() returned hardcoded string
   - Solution: Added model_name field, populated from ModelDefinition
   - Result: Correct model names in output (e.g., "e5-base-v2 model (768 dimensions)")

**Patterns Observed:**

1. **Default Trait Implementations Enable Backward Compatibility**
   - embed_query/embed_passage default to embed() means no breaking changes
   - Symmetric models get free implementation
   - Only asymmetric models need to override

2. **Pass Configuration Through Layers**
   - ModelDefinition → Factory → OnnxEmbedder → behavior
   - Clean separation: config defines "what", code implements "how"
   - Easy to add new models: just update registry.toml

3. **Dimension from Context Not Hardcoded**
   - ObservationStorage gets dimension from embedder at runtime
   - Single source of truth (ModelDefinition.dimensions)
   - No magic numbers scattered through code

4. **Test Real Models to Find Real Bugs**
   - Theoretical design looked complete after prefix support
   - Testing bge-base revealed dimension bug
   - Testing e5-base validated dual-prefix implementation
   - Each model tested found or validated an edge case

**Benchmark Results:**

| Model | Dims | Size | Prefix | Avg Similarity | vs Baseline |
|-------|------|------|--------|----------------|-------------|
| all-minilm-l6-v2 | 384 | 23MB | None | 0.542 | baseline |
| bge-small-en-v1.5 | 384 | 32MB | Query | 0.699 | +29% |
| bge-base-en-v1.5 | 768 | 181MB | Query | 0.737 | +36% |
| e5-base-v2 | 768 | 104MB | Dual | 0.846 | +56% |

**Status**: Model abstraction complete and validated across 4 production models. Ready for Phase 1A (event sourcing) or model selection decision.


### 19:39 - Update (covering since 19:33)

**Git Activity:**
- Commits this session:        0
- Files changed: 5
- Last commit: 12 minutes ago

**Work Completed:**
- Documented session update with comprehensive details of both commits
- Captured benchmark results showing e5-base-v2 as clear winner (+56% improvement)
- Session ready for archiving with complete record of model abstraction work

**Status**: Session complete, ready to archive


## Session Classification
- Work Type: experiment
- Files Changed:        9
- Commits:        2
- Patterns Modified:        0
- Session Tags: session-20251116-164846-start..session-20251116-164846-end
