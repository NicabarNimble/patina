# Session: Phase 3 review before begin
**ID**: 20251215-065917
**Started**: 2025-12-15T11:59:17Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251215-065917-start
**Starting Commit**: 4f73e1776c334cc66d16a936e6f9e82e3aeea368

## Previous Session Context
Last session completed a **deep ML-style review** (Andrew Ng/Amidi analysis) of Phase 2 progress. Key accomplishments: (1) Verified Phase 2 exit criteria MET - MRR 0.624 exceeds 0.3 target (36x improvement from start), (2) Found BM25 score scale mismatch between code_fts and pattern_fts tables causing pattern retrieval to underperform, (3) Merged PR #58 with documentation updates, (4) Recommended separate pattern oracle as Phase 2.7g enhancement. Open items: ground truth expansion (20→50+ queries), hyperparameter tuning, session MCP tools.

## Goals
- [x] Phase 3 review before begin
- [x] Understand retrieval architecture and multi-project gap
- [x] Document Phase 2.8 multi-project RAG approach
- [ ] Implement Phase 2.8 (deferred to next session)

## Activity Log
### 06:59 - Session Start
Session initialized with goal: Phase 3 review before begin
Working on branch: patina
Tagged as: session-20251215-065917-start

### 07:30 - Andrew Ng Style Phase 3 Review
- Reviewed all layer/core patterns (dependable-rust, unix-philosophy, adapter-pattern)
- Confirmed Phase 2 exit criteria MET (MRR 0.624 > 0.3 target)
- Discussed measurement validity concerns (20 queries, Patina-only)
- Decision: "Learn by shipping" (Option C) - get real-world signal by using on more projects

### 08:00 - Multi-Project Gap Discovery
**Key finding:** Projects are knowledge islands. Each has its own `.patina/data/` and they don't communicate.

Existing infrastructure:
- Mothership (`~/.patina/`) with `registry.yaml` tracking all projects/repos
- HTTP API (`patina serve`) already has `--repo` and `--all-repos` support
- Scry already supports multi-repo queries

**Gap:** MCP/Oracle layer doesn't expose this. The new RAG architecture (oracles, QueryEngine, RRF) is single-project only.

### 08:30 - First Implementation Attempt (Wrong)
Attempted to fix by:
1. Adding `QueryOptions` struct to `oracle.rs`
2. Updating `Oracle` trait to accept `QueryOptions`
3. Threading options through all oracles to scry

**Problems identified:**
- `QueryOptions` duplicates `ScryOptions` (unnecessary)
- Each oracle loops through repos independently (inefficient: 3 oracles × N repos)
- PersonaOracle accepts params it ignores (code smell)
- Violates clean layering - MCP-specific concerns leaked into retrieval layer

### 09:00 - Architecture Correction
User correctly pushed back: "MCP should be its own layer, not hardcoded into CLI tools"

**Correct architecture:**
```
INTERFACE LAYER (thin adapters)
├── MCP Server → parses params, calls QueryEngine
├── HTTP API → same
└── CLI → same

RETRIEVAL LAYER (the smarts)
├── QueryEngine → handles federation, coordinates oracles, RRF
└── Oracles → simple: query(query, limit) - single project only

CORE TOOLS
└── scry, persona, registry
```

**Key principles:**
- Oracles stay simple (unix-philosophy: one job)
- Federation logic in ONE place (QueryEngine)
- MCP is thin adapter (adapter-pattern)
- Lab benchmarks test same code path as MCP

### 09:30 - Documentation Updates
- Updated `layer/core/build.md` Phase 2.8 with correct approach
- Updated `layer/surface/build/spec-agentic-rag.md` with layering principle
- Documented wrong approach as learning (attempted then reverted)

### Key Decisions Made
1. **Phase 2.8 approach:** QueryEngine handles federation, oracles stay simple
2. **MCP is thin:** Just parses params and delegates to retrieval layer
3. **No QueryOptions in Oracle trait:** Keep it `query(query, limit)`
4. **Revert needed:** Uncommitted changes from wrong approach need to be reverted

### Files Changed (uncommitted - TO BE REVERTED)
- `src/retrieval/oracle.rs` - Added QueryOptions (REVERT)
- `src/retrieval/oracles/semantic.rs` - Changed to use QueryOptions (REVERT)
- `src/retrieval/oracles/lexical.rs` - Changed to use QueryOptions (REVERT)
- `src/retrieval/oracles/persona.rs` - Changed to use QueryOptions (REVERT)
- `src/retrieval/engine.rs` - Changed to use QueryOptions (REVERT)
- `src/retrieval/mod.rs` - Export QueryOptions (REVERT)
- `src/mcp/server.rs` - Added repo params to tool schema (KEEP - but simplify handler)
- `src/commands/bench/internal.rs` - Changed to use QueryOptions (REVERT)

### Files Changed (committed)
- `layer/core/build.md` - Phase 2.8 documentation (commit dd7e81e9)
- `layer/surface/build/spec-agentic-rag.md` - Layering principle (uncommitted - KEEP)

### Next Session TODO
1. Revert oracle/engine changes to restore simple `query(query, limit)` signature
2. Implement federation in QueryEngine (not oracles)
3. Keep MCP tool schema additions but simplify handler
4. Test multi-repo query flow
5. Run `patina bench` to verify no regression


## Session Classification
- Work Type: pattern-work
- Files Changed:        2
- Commits:        2
- Patterns Modified:        2
- Session Tags: session-20251215-065917-start..session-20251215-065917-end
