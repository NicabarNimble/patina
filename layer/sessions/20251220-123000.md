# Session: phase 1.5 and phase 2 Begin
**ID**: 20251220-123000
**Started**: 2025-12-20T17:30:00Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251220-123000-start
**Starting Commit**: 29a05ba8e93ce9a4d8611181be8566f47fe67274

## Previous Session Context
Completed Phase 1: implemented `assay derive` subcommand (~200 lines) computing structural signals (is_used, importer_count, activity_level, centrality), wired StructuralOracle into scry's RRF fusion, and established baseline metrics (MRR: 0.542, Recall@5: 42.7%). Discovered that relative imports (`use super::foo`) cause false negatives for import matching. Key insight crystallized: "Many weak signals > One accurate signal" - signals don't need to be accurate, just correlated and cheap. Created Phase 1.5 spec for robust signals using git-based (~95% accurate) and filename-based (~99% accurate) signals to boost MRR to 0.60+.

## Goals
- [ ] phase 1.5 and phase 2 Begin

## Activity Log
### 12:30 - Session Start
Session initialized with goal: phase 1.5 and phase 2 Begin
Working on branch: patina
Tagged as: session-20251220-123000-start


### 13:24 - Update (covering since 12:30)

**Git Activity:**
- Commits this session: 0
- Files changed: 4
- Last commit: 71 minutes ago

**Work Completed:**
- Deep dive into layer/sessions to understand phase naming evolution (read 7 sessions Dec 16-20)
- Updated build.md structure: Phase 1 → Complete, Phase 1.5 → Current Work, Phase 2 → Next
- Implemented all Phase 1.5 signals in assay derive (~169 lines added):
  - `commit_count`: git eventlog query per file
  - `contributor_count`: COUNT DISTINCT authors
  - `is_entry_point`: pattern match (main.rs, lib.rs, mod.rs, index.ts, __init__.py, etc.)
  - `is_test_file`: path/filename patterns (/test/, _test.rs, .spec.ts)
  - `directory_depth`: count of `/` separators
  - `file_size_rank`: percentile rank (0-1) based on file size
- Updated StructuralOracle with SQL-based normalization and composite score (~77 lines changed)
- Ran lab metrics: MRR 0.554 (+2.2% from baseline 0.542), Recall@5 unchanged at 42.7%

**Discussion Context:**
- User asked to anchor in layer/core values before working on build.md
- Session archaeology revealed phases are work streams, not sequences (release track vs structural track)
- spec-pipeline.md already had Phase 1/2/3 plan that I initially missed
- User wanted detailed context from previous sessions before defining new phases

**Key Decisions:**
1. Phases are parallel work streams, not strict sequences - Phase 2 (release) and Phase 3 (feedback) are done, Phase 1.5 (signals) is current
2. Normalization done at query time via SQL CTEs (not stored normalized values) - simpler, no schema migration
3. Composite score weights: commits 0.20, freshness 0.20, contributors 0.15, importers 0.15, centrality 0.10, depth 0.10, size 0.05, entry_point 0.05

**Challenges Faced:**
- Minimal retrieval improvement despite signals working correctly
- Root cause: structural oracle returns file-level doc_ids while other oracles return symbol-level
- RRF fusion can't combine them because doc_ids don't match
- Solution captured for Phase 2: need to boost semantic/lexical results using structural signals, not as separate oracle

**Patterns Observed:**
- Session archaeology is valuable for understanding context before making changes
- "Phases" need clear definitions - they were referenced but not formally defined
- SQL CTEs with window functions work well for signal normalization at query time
- Doc_id format consistency matters for RRF fusion to work effectively


### 13:37 - Note [patina@29a05ba8]
Phase 2 structural boost results: boost factors 0.1-0.5 tested, no MRR improvement. Key insight: structural signals are orthogonal to semantic relevance - activity/commits don't correlate with query relevance for this query set. Implementation sound but hypothesis wrong. Options: keep 0.1 boost (neutral), remove entirely, or future query-type routing.

### 13:37 - Update (covering since 13:24)

**Git Activity:**
- Commits this session: 0
- Files changed: 5
- Last commit: 84 minutes ago

**Work Completed:**
- Implemented Phase 2 structural boost layer in engine.rs (~140 lines):
  - `load_structural_scores()`: SQL CTE to compute composite scores from module_signals
  - `extract_file_path()`: Parse file path from doc_id (handles `./src/main.rs::main:main` format)
  - `apply_structural_boost()`: Multiply RRF scores by (1 + boost_factor * composite_score)
- Removed StructuralOracle from oracle list (now a boost layer, not separate oracle)
- Tested boost factors: 0.1, 0.2, 0.5
- Updated build.md with Phase 2 definition and results

**Key Decisions:**
1. Structural signals become a boost layer, not a separate oracle - solves doc_id mismatch issue
2. Boost factor 0.1 chosen - neutral impact on current query set, preserves option for future tuning
3. PageRank/staleness work deferred to Phase 2.5 until boost approach validated

**Challenges Faced:**
- Higher boost factors (0.2, 0.5) caused MRR regression - structural signals pushed wrong files up
- Structural signals are orthogonal to semantic relevance for current query set
- "Activity" and "centrality" don't correlate with "is this file relevant to the query"

**Patterns Observed:**
- **Hypothesis testing via benchmarks** - systematic boost factor sweep revealed the signal-relevance disconnect
- **Signals have different use cases** - structural signals help "what's important" queries, not "where is X" queries
- **Implementation was sound, hypothesis was wrong** - the boost layer works correctly, just doesn't help this use case


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20251220-123000-start..session-20251220-123000-end
