# Session: mothership and cross project awarness and domain knoweldge sharing questions
**ID**: 20251222-141635
**Started**: 2025-12-22T19:16:35Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20251222-141635-start
**Starting Commit**: 6dd86b0ceae8b0e0348b818d3e5559edba78745a

## Previous Session Context
The previous session explored the layer folder structure during `patina init`. It was classified as an exploration session with no commits made. The session examined how the layer directory (core/, surface/, dust/, sessions/) gets initialized and structured for new projects.

## Goals
- [ ] mothership and cross project awarness and domain knoweldge sharing questions

## Activity Log
### 14:16 - Session Start
Session initialized with goal: mothership and cross project awarness and domain knoweldge sharing questions
Working on branch: patina
Tagged as: session-20251222-141635-start


### 15:56 - Note [patina@6dd86b0c]
What happened:
1. The scry with all_repos: true fired - so cross-repo querying does exist
2. But the result was garbage - a dojo macro file about type_contains_usize for a query about '1password yolo containers'
3. It fell back to manual grep which found nothing (because 1Password isn't in Patina)

What this reveals:
1. Cross-repo scry exists but quality is poor - The lexical match on random tokens dominated
2. No persona knowledge injected - persona isn't wired into scry yet
3. The 'all_repos' feature is there but not useful yet - no intelligence to distinguish patterns from code

The fix needed: Persona oracle integration into scry, so cross-project knowledge gets fused with code search results.

### 17:03 - Update (covering since 14:16)

**Git Activity:**
- Commits this session:        0
- Files changed: 4
- Last commit: 4 hours ago

**Work completed:**
- Created spec-persona-fusion.md - makes PersonaOracle visible in scry output with [PROJECT]/[PERSONA] tagging
- Created spec-secrets-boundary.md - 1Password integration for LLM/git secret protection via op:// references
- Deep investigation of cross-project knowledge architecture
- Root cause analysis of why layer docs don't surface in scry results

---

## Deep Dive: Cross-Project Knowledge Architecture

### What We Explored

Started with user's experience from unraid project:
- `patina scry "yolo container 1password" --all-repos` returned garbage
- Dojo macro file about `type_contains_usize` for a 1Password query
- This revealed cross-project scry exists but quality is poor

### The Vision Document (spec-pipeline.md)

Found the comprehensive vision document already exists at `layer/surface/build/spec-pipeline.md`:
- Full Picture: Mothership (~/.patina/) ↔ Project ↔ LLM Frontend
- Pipeline: scrape → SQLite → oxidize/assay → scry
- 5 Oracles: Semantic, Structural, Lexical, Temporal, Persona
- Multi-user future with git as coordination mechanism
- Andrew Ng / Rich Sutton perspectives on the architecture

### What Already Exists (Verified via code)

1. **PersonaOracle** - `src/retrieval/oracles/persona.rs`
   - IS wired into QueryEngine at `engine.rs:73`
   - Queries `~/.patina/cache/personas/default/persona.db`
   - Returns results with source="persona"

2. **Layer doc scraping** - `src/commands/scrape/layer/mod.rs`
   - Scrapes `layer/core/*.md` and `layer/surface/**/*.md`
   - Creates `patterns` and `pattern_fts` tables
   - 33 patterns currently indexed

3. **Layer doc embedding** - `src/commands/oxidize/mod.rs:292-297`
   - Layer patterns ARE included in oxidize embeddings
   - "Indexed 2475 session events + 1213 code facts + 33 patterns"

4. **Cross-repo query** - `engine.rs:207-253`
   - `all_repos: true` federates across registered repos
   - PersonaOracle included once (correctly, not per-repo)

### The Mystery: Why Don't Layer Docs Surface?

Tested with query "Pipeline Architecture unified oracle":
- spec-pipeline.md ranked **#1 in lexical** (BM25: 12.3)
- spec-pipeline.md ranked **#1 in semantic** (cosine: 0.90)
- But final fused position was **#5** (score: 0.033)
- Code symbol "analyze_architecture" was **#1** (score: 0.115)

### Root Cause Found: code_fts Duplication Bug

```sql
SELECT symbol_name, event_type FROM code_fts
WHERE file_path LIKE '%scry/mod.rs%' AND symbol_name = 'scry';

scry|code.symbol
scry|code.function
scry|code.symbol
scry|code.function
... (8 total duplicates)
```

**Every code symbol is inserted 8 times** (4 as code.symbol, 4 as code.function).

RRF fusion math:
- spec-pipeline with ranks #1, #1: 1/61 + 1/61 = 0.033 ✓
- code symbol with 8 entries: 1/61 + 1/62 + 1/63... ≈ 0.115 ✓

**The fusion is correct. The data is duplicated.**

### Connection to Dec 14 Session

Session `20251214-175410.md` found the same issue:
- "Verified pattern_fts results - found BM25 score scale mismatch"
- "Recommendation: Option 3 (separate oracle) aligns with unix-philosophy"

But this was **never added to build.md** - it only exists in session notes.

---

## Specs Created This Session

### spec-persona-fusion.md
- Makes PersonaOracle contributions visible in scry output
- Adds [PROJECT]/[PERSONA] source tagging to results
- Depends on Observable Scry Phase 1 completing first
- Phase 1: Observability (via --explain)
- Phase 2: Source tagging in output

### spec-secrets-boundary.md
- 1Password integration for secure secrets management
- LLMs never see secret values, only op:// references
- Git never contains actual secrets
- Defense in depth: config schema, scrape detection, context filtering
- Four phases: Config schema → Detection → Context filtering → Resolution

---

## Key Decisions

1. **Don't add PatternOracle or boosts** - Fix data quality first
2. **Fix scrape deduplication** - This is the root cause, not fusion algorithm
3. **Observable Scry enables diagnosis** - --explain flag would reveal duplicates immediately
4. **New specs queue after Observable Scry** - persona-fusion → secrets-boundary

---

## Architecture Alignment

| Component | In spec-pipeline.md? | Status |
|-----------|----------------------|--------|
| SemanticOracle | Yes | Working |
| StructuralOracle | Yes | Removed from fusion (available via assay) |
| LexicalOracle | Yes | Working but data has duplicates |
| TemporalOracle | Yes | Working |
| PersonaOracle | Yes | Working but results not visible |
| Secrets | No | New spec (additive) |

No architectural conflicts. New specs are either completing existing vision (persona) or adding orthogonal concerns (secrets).

---

**Patterns observed:**
- Session discoveries don't always flow into build.md (process gap)
- Data quality issues masquerade as algorithm problems
- Need to verify assumptions with actual database queries
- The vision document (spec-pipeline.md) should be consulted first
- When ranking seems wrong, check for data duplication before changing algorithms


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20251222-141635-start..session-20251222-141635-end
