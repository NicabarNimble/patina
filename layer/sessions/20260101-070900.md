# Session: improve
**ID**: 20260101-070900
**Started**: 2026-01-01T12:09:00Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20260101-070900-start
**Starting Commit**: 163d8c8c6313ef589be071d54a4b3f8ad028d9c1

## Previous Session Context
Last session (spec) completed a comprehensive spec-to-code audit: verified 6 specs as accurate (llm-frontends, architectural-alignment, pipeline, assay, quality-gates, secrets-v2), fixed spec-github-adapter.md to reflect bounty detection was removed (stub code), and identified 3 future specs not yet implemented. Key pattern reinforced: code-first verification catches documentation drift where specs claim features that don't exist.

## Goals
- [ ] Improve knowledge retrieval system

## Activity Log
### 07:09 - Session Start
Session initialized with goal: improve
Working on branch: patina
Tagged as: session-20260101-070900-start


### 08:01 - Update (covering since 07:09)

**Git Activity:**
- Commits this session:        0
- Files changed: 1 (spec-retrieval-optimization.md created)
- Last commit: 54 minutes ago

**Work Completed:**
- Deep analysis of Patina's knowledge retrieval architecture
- Traced actual MCP → QueryEngine → Oracle → scry_text code paths
- Created comprehensive spec: `layer/surface/build/spec-retrieval-optimization.md`
- Three revision passes: initial analysis → Andrew Ng principles → code verification

**Key Decisions:**
1. **Real bottleneck identified**: Model loading per-query (200-500ms), not embedding latency (100ms). Both SemanticOracle and PersonaOracle call `create_embedder()` on every query.
2. **StructuralOracle removed from plan**: Was previously tried and removed (see spec-work-deferred.md:210-258). Design bug with doc_id granularity mismatch. Added to anti-patterns.
3. **Use existing eval infrastructure**: `patina eval` command exists (597 lines), don't rebuild.
4. **Phase 0 mandatory**: Baseline measurement before any optimization (Ng principle).

**Challenges & Solutions:**
- Initial spec assumed "embedding latency" was the bottleneck. Code verification revealed the REAL issue is model/projection/index loaded from disk on every query.
- Spec originally proposed "add StructuralOracle" but spec-work-deferred.md revealed it was already tried and removed. Updated spec to explain why and added anti-pattern.

**Patterns Observed:**
- Code-first verification catches assumptions (same pattern as last session's spec audit)
- Andrew Ng's "measure first, simple baseline" aligns with Patina's unix-philosophy
- dependable-rust principle violated: Oracles should own their heavy resources (embedder, index)


### 08:04 - Note [patina@163d8c8c]
Verify assumptions against code paths, not documentation. Trace the actual execution flow - bottlenecks are often not where you think.

### 08:04 - Note [patina@163d8c8c]
Check deferred/archived work before proposing features. Prior attempts and their failure modes are valuable context.

### 08:04 - Note [patina@163d8c8c]
Priors (importance) and relevance (query-match) are different signals. Mixing granularities in fusion doesn't work - need query-type routing first.

### 08:05 - Update (covering since 08:01)

**Git Activity:**
- Commits this session:        0
- Files changed: 1
- Last commit: 59 minutes ago

**Work Completed:**
- Added 3 session notes capturing reusable insights
- Discussed git tags for notes (deferred - keep simple)
- Final verification pass complete

**Session Summary:**
Created `spec-retrieval-optimization.md` - a code-verified, Ng-principled spec for improving Patina's knowledge retrieval. Ready for implementation in 5 phases.


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20260101-070900-start..session-20260101-070900-end
