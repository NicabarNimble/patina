---
type: session
id: 20260203-164327
title: refactor/security-hardening spec
status: archived
llm: claude
created: 2026-02-03T21:43:28Z
start_timestamp: 1770155008013
git:
  branch: patina
  starting_commit: bdf20b7fe97aaea3a22201b1336761aae2747fab
  start_tag: session-20260203-164327-claude-start
---

## Previous Session Context
Conducted a security audit (Litchfield/Davidoff style) of the Patina CLI, identifying 14 findings across P0/P1/P2 priorities — most critical being the zero-auth HTTP daemon in `serve/internal.rs`. Created the `security-hardening` spec with phased fix plans and code sketches, then wired it into `build.md` with versioning (single 0.10.1 patch release). Also ground-truthed D0-D5 mother-delivery specs against actual codebase, fixing 5 inaccuracies.

## Goals
- [x] Implement P0 security hardening for `patina serve`
- [x] Review and fix implementation gaps (read cap, concurrency, errors)
- [x] Update [[security-hardening]] spec to match shipped code
- [x] Capture [[transport-security-by-trust-boundary]] belief
- [ ] Execution bounding (timeout + concurrency gate) — deferred, needs design

## Activity Log
### 16:43 - Session Start
Session initialized with goal: refactor/security-hardening spec
Working on branch: patina
Tagged as: session-20260203-164327-claude-start

### 17:00 - P0 v1: Six Mechanical Fixes
Implemented 6 fixes in `src/commands/serve/internal.rs`:
1. Bearer token auth (`PATINA_SERVE_TOKEN` env or random 32-byte hex via `fastrand`)
2. Content-Length body size check (>1MB → 413)
3. Limit cap (`body.limit.min(1000)`)
4. Query timeout (`thread::spawn` + `mpsc::recv_timeout(30s)` → 504)
5. CORS deny (`Access-Control-Allow-Origin: null`)
6. Bind warning on non-localhost

All verified with curl. Build + clippy + 291 tests pass.

### 17:30 - Review: Three Gotchas Found
External review notes identified real gaps in v1:
- **Gotcha A**: Content-Length is advisory — can be absent or wrong. `unwrap_or(0)` on parse failure disables the guard entirely.
- **Gotcha B**: `thread::spawn` + `recv_timeout` returns 504 but the query thread keeps running. Thread/DB connection leak under repeated timeouts.
- **Gotcha C**: `thread::spawn` per request with no concurrency bound = DoS vector.

### 17:45 - P0 v2: Fixed A, Added B+C (Semaphore)
- Replaced Content-Length check with `Read::take(MAX_BODY_SIZE + 1)` (read cap on actual stream)
- Added `AtomicUsize` semaphore for concurrency gate (`MAX_CONCURRENT_QUERIES = 4`)
- Replaced `Access-Control-Allow-Origin: null` with `X-Content-Type-Options: nosniff` + `X-Frame-Options: DENY`
- Added `json_error()` helper for consistent JSON error responses

### 18:00 - Edge Case Walkthrough: Three Bugs in v2
Traced three edge cases:
1. **Mother client breaks** — `src/mother/internal.rs` `Client::scry()` sends no `Authorization` header. Container→mother workflow gets 401. Breaking change.
2. **Semaphore TOCTOU** — `load` then `fetch_add` allows concurrent requests to all pass the check. Not a strict bound.
3. **Panic counter leak** — if `execute_scry_query` panics, `fetch_sub` never runs. After 4 panics, server permanently returns 503.

### 18:15 - P0 v3: Strip Concurrency, Ship What's Solid
User correctly identified the churn pattern — fixing problems that create new problems. Decision: remove semaphore and timeout entirely. Ship the 6 things that are solid, defer execution bounding for proper design.

Final P0 (shipped):
1. Bearer token auth
2. Read-cap body enforcement (`Read::take`, not Content-Length trust)
3. Limit cap at 1000
4. Security headers (nosniff, DENY, no CORS origin header)
5. Bind warning
6. Consistent JSON errors

Updated [[security-hardening]] spec: execution bounding moved to "Deferred: needs design" section with explanation of TOCTOU, panic leak, thread abandonment issues.

### 18:30 - Architectural Discussion: Secrets-First Security
Explored how `PATINA_SERVE_TOKEN` bypasses Patina's own secrets infrastructure (vault, keychain, age encryption). Added P1 item 11: wire serve token through vault (load order: vault → env var → generate).

Deeper analysis: the HTTP transport itself is the problem. Bearer-over-plaintext stops blind CSRF but not network observers. Patina already has the crypto primitives (age X25519, multi-recipient vault, keychain identity) — they're just not wired to the transport.

Design target (djb principle): Unix socket for local (file permissions = auth), TLS/SSH for network (mutual key auth via age keys), plain HTTP never the default. Prior art: PostgreSQL, Docker.

### 18:45 - Belief Captured
Created [[transport-security-by-trust-boundary]]: split transport by trust boundary. Supports [[dependable-rust]] and [[mcp-is-shim-cli-is-product]]. Applied-in: `serve/internal.rs`, `secrets/session.rs`, `mother/internal.rs`.

Drafted next-session prompt for security-by-design implementation.

## Beliefs Captured: 1
- [[transport-security-by-trust-boundary]] — Unix socket for local, mutual age-key auth for network, never plain HTTP as default


## Beliefs Captured: 1

## Session Classification
- Work Type: pattern-work
- Files Changed: 4
- Commits: 2
- Patterns Modified: 2
- Beliefs Captured: 1
- Session Tags: session-20260203-164327-claude-start..session-20260203-164327-claude-end

## User Prompts (18)

1. `[Pasted text #1 +21 lines] anchor in layer/core values. read code before write code. git update w...`
2. `is any of this relevant? [Pasted text #1 +105 lines]`
3. `fix A, B, C now`
4. `update spec first with what and why then change`
5. `ok any breaking changes or new edge cases? do a walk through on 3 possible edge cases .`
6. `i'm concerend that these changes you are making are nto well thought out that you have some inter...`
7. `2`
8. `great now explain to me what these security changes do and how they fix our code`
9. `how does PATINA_SERVE_TOKEN relate to secrets?`
10. `yes add it to the spec`
11. `so i wonder would it make sense for us to build our security around our secrets design?`
12. `ok .. so what is secrets function? whats it role in our patina system?`
13. `great and what problem did we solve that touches secrets?`
14. `ok .. stepping back and looking at our system and the fixes we just added. how could we design mo...`
15. `capture this as a belief`
16. `/context `
17. `ok .. i want to go deep on this secruity concept next session so draft a prompt that holds this c...`
18. `/session-end `
