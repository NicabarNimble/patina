---
type: session
id: 20260204-123509
title: continue D0 work - eval update and D1
status: archived
llm: claude
created: 2026-02-04T17:35:10Z
start_timestamp: 1770226510048
git:
  branch: patina
  starting_commit: 27aa92c1d1fbf24c46c049a116cb797fc9fbb63d
  start_tag: session-20260204-123509-claude-start
---

## Previous Session Context
Completed nearly all of D0 (8/9 exit criteria) in a single session: fixed CLI to use QueryEngine by default (Andrew Ng baseline showed 1 result vs 5), removed `--hybrid`/`--lexical`/`--dimension` flags, added `--legacy` escape hatch, unified serve daemon to always use QueryEngine (-99 lines net across 5 files). Discovered spec challenge when removing `dimension` would break `patina eval` ablation testing — kept it as internal-only field. Captured 2 beliefs: `bridges-become-permanent` and `spec-challenge-traceback`. Remaining: `patina eval` benchmark verification (eval command needs updating to test QueryEngine output).

## Goals
- [ ] Update `patina eval` to test QueryEngine pipeline (D0 last exit criterion)
- [ ] Implement D1 BeliefOracle
- [x] Anchor in layer/core values, read code before write code
- [x] Capture eval design in spec after failed first attempt

## Activity Log
### 12:35 - Session Start
Session initialized with goal: continue D0 work - eval update and D1
Working on branch: patina
Tagged as: session-20260204-123509-claude-start

### 12:55 - Update (covering since 12:35)

**Git Activity:**
- Commits this session: 1 ([[72658617]])
- Last commit: `docs(d0): eval design — unified + ablation, not either/or`
- Clean working tree (2 untracked session archives)

**Work Completed:**

1. **Anchored in layer/core values** — Read all three core documents (`dependable-rust.md`, `unix-philosophy.md`, `adapter-pattern.md`) and `build.md` before touching code. Key values for D0/D1: unix-philosophy ("new functionality = new commands, not new flags"), dependable-rust (Oracle trait as black-box interface), adapter-pattern (trait objects for oracle registration).

2. **Deep read of eval + retrieval pipeline** — Read 5 key files (~1,600 lines): `eval/mod.rs`, `scry/mod.rs`, `scry/internal/hybrid.rs`, `retrieval/engine.rs`, `retrieval/mod.rs`. Also read `search.rs`, `enrichment.rs`, `fusion.rs`, `oracle.rs`, `intent.rs`, and all 4 oracle implementations (semantic, lexical, temporal, persona).

3. **Found the eval bug** — `eval/mod.rs:327-329`: `scry()` is an alias for `scry_text()`, the legacy direct vector search. Eval never touches QueryEngine. The `dimension` field on `ScryOptions` routes to different USearch indices in `scry_text()`, but `execute_hybrid()` (QueryEngine path) ignores it entirely. Eval has been testing the old path since D0 shipped.

4. **First implementation attempt (reverted)** — Replaced `scry()` with `QueryEngine::query()`. Changed semantic ground truth from session observations (seq ID matching) to function_facts (doc_id matching). Problem identified by user: this **replaced** individual oracle measurement with unified measurement instead of **adding** unified alongside it. Applied [[spec-challenge-traceback]]: stop coding when implementation reveals spec assumption was wrong.

5. **Identified dedup problem** — SemanticOracle enriches results via `enrich_results()` which maps eventlog seq → source_id as doc_id. Multiple session observations from the same session share one source_id. RRF deduplicates by doc_id → max 1 hit per session. Old ground truth (match by seq ID) is fundamentally broken for the QueryEngine path.

6. **Captured correct design in D0 spec** ([[72658617]]) — "Default the switches": unified pipeline is default, per-oracle ablation becomes switches. `patina eval` creates 3 engines (unified, semantic-only, temporal-only) and runs same queries through each. Shows side-by-side comparison. Semantic ground truth changes to `function_facts` co-retrieval (unique doc_ids per function, no dedup issue).

**Discussion Context:**
- User's key insight: "why not default the switches and add switches for plain .. what do we lose in that world?" Answer: nothing. You gain more measurement.
- This is the Andrew Ng principle applied to the eval itself: keep ablation testing capability alongside system measurement
- User caught the spec-challenge moment before code was committed — the revert was clean (git checkout)

**Key Decisions:**
- Eval will test unified pipeline + per-oracle ablation in one pass (not either/or)
- Semantic ground truth changes from session observations to function_facts co-retrieval
- `ScryOptions.dimension` stays (legacy path, mother routing) but eval stops using it
- D1 (BeliefOracle) deferred to next session — eval design needed to land first

**Patterns Observed:**
- Reading code before writing caught the `scry()` → `scry_text()` alias that would have been invisible otherwise
- The spec-challenge-traceback belief was applied in the same session it was created (previous session)
- User acted as the measurement guardian — "can we still measure the raw inputs?" prevented a regression in eval capability
- Git as undo: `git checkout -- file` is the cleanest revert for a file that was never committed


## Beliefs Captured: 0
_No beliefs captured this session_

## Session Classification
- Work Type: pattern-work
- Files Changed: 1
- Commits: 1
- Patterns Modified: 1
- Beliefs Captured: 0
- Session Tags: session-20260204-123509-claude-start..session-20260204-123509-claude-end

## User Prompts (7)

1. `[Pasted text #1 +39 lines]`
2. `anchor in layer/core values. read code before write code. git update with scalpel not shotgun`
3. `start with eval update, then D1`
4. `before we build .. i have a question .. we used to meassure each part scry assay etc now we have ...`
5. `so my goal is to meassure the same things we had before or more things .. AND to call those thing...`
6. `we wont have enough context to do this edit .. update the spec so that we can learn from our mist...`
7. `/session-end `
