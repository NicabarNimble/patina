---
type: session
id: 20260204-125850
title: D0 eval implementation + D1 BeliefOracle
status: archived
llm: claude
created: 2026-02-04T17:58:50Z
start_timestamp: 1770227930217
git:
  branch: patina
  starting_commit: 72658617a611a9e3e47b5e76fd350b447f506c04
  start_tag: session-20260204-125850-claude-start
---

## Previous Session Context
Last session deep-read the eval and retrieval pipeline (~1,600 lines across 10+ files), found the eval bug (`scry()` is an alias for `scry_text()` — eval never touches QueryEngine), attempted a fix that replaced per-oracle measurement with unified-only (reverted), then captured the correct design in the D0 spec: unified pipeline as default + per-oracle ablation as switches, with semantic ground truth changing from session observations to `function_facts` co-retrieval. D1 BeliefOracle was deferred. Key open items: implement the eval update per the new spec, then build D1 BeliefOracle.

## Goals
- [x] D0 eval implementation — unified + per-oracle ablation
- [x] D1 BeliefOracle — beliefs as default search channel

## Activity Log
### 12:58 - Session Start
Session initialized with goal: D0 eval implementation + D1 BeliefOracle
Working on branch: patina
Tagged as: session-20260204-125850-claude-start


### 13:37 - Update (covering since 12:58)

**Git Activity:**
- Commits this session: 2 ([[52edbf20]], [[1c81d112]])
- Files changed: 5 (1 rewritten, 3 modified, 1 new)
- Clean working tree (3 untracked session archives)

**Work Completed:**

1. **Deep context gathering** — Read 11 files in order per user's reading list: last session notes, D0 spec (eval design section), `eval/mod.rs`, `engine.rs`, `fusion.rs`, `oracle.rs`, D1 spec. Then read `intent.rs`, `oracles/mod.rs`, `semantic.rs`, `retrieval/mod.rs`, `bench/internal.rs` (QueryEngine pattern), `enrichment.rs` (doc_id format details), `temporal.rs`, `lexical.rs`. Ran `patina --help`, checked `main.rs` CLI dispatch, queried SQLite for `function_facts` schema/data, `co_changes` format, `belief_fts` content. Total: ~3,000 lines read across 15+ files.

2. **D0 eval rewrite** ([[52edbf20]]) — Replaced legacy `scry()`/`ScryOptions` imports with `QueryEngine`/`RetrievalConfig`/`FusedResult`. Creates 3 engines: unified (all oracles), semantic-only (`oracle_filter`), temporal-only. Semantic ground truth changed from session observations (broken under RRF dedup) to `function_facts` co-retrieval. Added helpers: `extract_file_from_doc_id()`, `normalize_path()`, `count_file_hits()`. `--dimension` narrows which tests run, not which engines. `execute_feedback()` unchanged. Net: +214/-133 lines in `eval/mod.rs`.

3. **D1 BeliefOracle** ([[1c81d112]]) — New `src/retrieval/oracles/belief.rs` (425 lines). Channel A: vector search against shared USearch index with aggressive over-fetch (`limit * 50`), filtered to 4B-5B belief ID range. Channel B: FTS5 against existing `belief_fts` table. Internal merge: 0.7 vector + 0.3 text with BM25 normalization to [0,1] before combine. Wired into `default_oracles()` in `engine.rs` (both construction sites). Updated `IntentWeights` in `intent.rs`: added `belief` field, boosted 1.5x on Rationale and Definition intents. Updated `weight_for()` match.

4. **Live testing confirmed** — `patina eval` runs clean with 5 oracles, `patina scry "why should we commit often"` returns `belief:commit-early-commit-often` at position 2, PATINA_LOG debug shows belief oracle contributing 20 results per query.

**Discussion Context:**

- User asked about 5 architectural concerns (doc_id stability, enrichment heuristics, policy spaghetti, temporal LIKE-match weakness, OnceLock invalidation). Discussion concluded: none are issues today, all are documented risks for future. doc_id stability is a de facto contract already. TemporalOracle weakness is by design — it stays in its lane.

- User proposed **EvidenceOracle** (retrieves verification status, boosts results with strong verification). Discussed why this is the wrong abstraction: verification is a property OF a result, not an independent result. RRF dedup would lose verification content. Better pattern: post-fusion annotation (like existing `populate_annotations()`). Oracles retrieve, annotations qualify.

**Key Decisions:**
- BeliefOracle shares the SemanticOracle's USearch index (same cache pattern, same OnceLock) rather than a dedicated belief index — 47 beliefs don't justify a separate index
- BM25 scores normalized to [0,1] before weighted merge with cosine, because raw BM25 scores are on a different scale
- `is_available()` checks beliefs table has data (not just exists) — empty beliefs table means oracle shouldn't participate
- Over-fetch formula: `min(limit * 50, index_size / 2).max(limit)` — tuned for ~47 beliefs in ~38K index entries

**Patterns Observed:**
- [[read-code-before-write]] applied: reading 15 files first meant zero false starts. The bench/internal.rs read gave the exact `QueryEngine::with_config()` + `oracle_filter` pattern for eval
- [[spec-challenge-traceback]] applied implicitly: the spec's eval design section was the implementation guide, not the other way around
- SemanticOracle's `OnceLock` cache pattern was directly reusable for BeliefOracle — copy structure, change the search/filter logic
- The Oracle trait's black-box interface (dependable-rust) meant D1 was 4 files: 1 new, 3 small edits. No changes to fusion, no changes to formatting, no changes to MCP


### 13:43 - Update (covering since 13:37)

**Git Activity:**
- Commits this session: 3 ([[52edbf20]], [[1c81d112]], [[c1cb040c]])
- Last commit: [[c1cb040c]] `belief: add verification-is-annotation-not-retrieval`

**Work Completed:**
- Captured belief [[verification-is-annotation-not-retrieval]] from EvidenceOracle architecture discussion. Added 3 evidence links, supports [[dependable-rust]], 2 applied-in examples.


## Beliefs Captured: 1

## Session Classification
- Work Type: pattern-work
- Files Changed: 6
- Commits: 3
- Patterns Modified: 1
- Beliefs Captured: 1
- Session Tags: session-20260204-125850-claude-start..session-20260204-125850-claude-end

## User Prompts (10)

1. `[Pasted text #1 +53 lines]`
2. `understand patina --help and make sure to read the code that touches your edits .. and if you nee...`
3. `yes, eval first`
4. `lets fix busted test so we are not building more workarounds .. all test should pass .. they did ...`
5. `ok tell me in your words about or oracles .. what tey are called and what they do`
6. `are these issues?  doc_id stability is now a core contract, If enrichment starts doing heuristics...`
7. `ok commit eval, then start D1`
8. `/session-update`
9. `yes capture it`
10. `/session-end`
