# Session: ref-repo-semantic
**ID**: 20260107-113628
**Started**: 2026-01-07T16:36:28Z
**LLM**: claude
**Git Branch**: patina
**Session Tag**: session-20260107-113628-start
**Starting Commit**: 5bd27bad2def0f9fe9665b74d05310f28beabf33

## Previous Session Context
Last session (20260107-102433 "spec-ref-repo-semantic") completed Phase 2: refactored commits as first-class signal rather than fallback, updated docs/code to reflect this architectural framing, and defined Phase 3 (Measure & Optimize using Ng method). Key contributions: added "Authority: Who Declares Done?" section to spec-three-layers.md (Ralph Wiggum convergence insight), added "Convergence Signals" to spec-observability.md. Next up: Phase 3 - build eval queries for ref repos, measure commit signal quality.

## Goals
- [ ] Build test/eval queries for ref repos (Phase 3)
- [ ] Measure commit signal quality using Ng method
- [ ] Compare semantic vs FTS5 results on eval queries

## Activity Log
### 11:36 - Session Start
Session initialized with goal: ref-repo-semantic
Working on branch: patina
Tagged as: session-20260107-113628-start


### 13:28 - Update (covering since 11:36)

**Git Activity:**
- Commits this session:        0
- Files changed: 3
- Last commit: 2 hours ago

**Work Completed:**
- Deep investigation into why semantic search quality varies across repos
- Discovered key metrics: signal rate (5-36%), funcs/file (4.9-12.7), commit message quality
- Built eval queryset with ground truth for 4 repos (gemini-cli, opencode, dojo, codex)
- Created `eval/ref-repo-queryset.json` and `eval/run-ref-repo-eval.sh`
- Ran eval: 66-83% hit rate, 0.44-0.75 MRR across repos
- Error analysis: all 6 "failures" were ground truth issues, semantic was actually correct
- Ran `patina repo update --all --oxidize` on all 13 ref repos
- Discovered critical gap: recipe creation doesn't auto-enable semantic

**Key Findings:**
1. **Commit-based semantic works**: 75-83% hit rate despite static parameters
2. **Static values in commits.rs**: `length > 30`, moment weights `3.0/2.0/1.5/1.2/1.0`
3. **Recipe creation gap**: Default template is `[dependency, temporal]` not `[dependency, temporal, semantic]`
4. **Result**: Only 4/13 repos have semantic indexes (the ones that already had it in oxidize.yaml)

**Three Failure Scenarios Identified:**
1. Verbose enterprise repos (long templates, buried signal)
2. Tiny focused libraries (< 50 usable commits, repeated anchors)
3. Monorepos with mixed conventions (only catches one team's style)

**Key Decisions:**
- Follow Ng method: measure first, then optimize
- Don't jump to fixes (function-level blame, diff matching) without data
- Eval methodology matters: ground truth was too narrow

**Challenges:**
- Shell loop syntax issues with zsh
- Recipe creation logic doesn't include semantic for new repos despite having commits
- livestore failed on embedding generation (token length issue persists)

**Next Steps:**
- Document findings in spec-ref-repo-semantic.md
- Fix recipe creation to auto-enable semantic when commits exist
- Consider dynamic parameters vs static magic numbers


## Session Classification
- Work Type: exploration
- Files Changed:        0
- Commits:        0
- Patterns Modified:        0
- Session Tags: session-20260107-113628-start..session-20260107-113628-end
