---
type: session
id: 20260202-202802
title: Mother federated query spec and review and openclaw
status: archived
llm: claude
created: 2026-02-03T01:28:02Z
start_timestamp: 1770082082168
git:
  branch: patina
  starting_commit: 04e413ef673d7fc562304720e27d003f038fa527
  start_tag: session-20260202-202802-claude-start
---

## Previous Session Context
Reviewed epistemic spec completion status, confirmed all buildable phases E0-E4.6c are done. Explored the **delivery layer problem** — beliefs work as storage but don't surface during task-oriented queries (A/B eval showed delta -0.05 for task queries vs +2.2 for knowledge queries). Researched ref repos including [[openclaw/openclaw]] (8,308 commits, hybrid vector+keyword search via `MemoryIndexManager`) — found no ref repo solves automatic query-time belief routing. Identified 4 architectural options for belief delivery. Reconciled version drift, released [[v0.10.0]] with epistemic milestone complete, archived [[epistemic-layer]] spec, and set next milestone to `v0.11.0 — Mother federated query`.

## Goals
- [ ] Mother federated query spec and review and openclaw

## Activity Log
### 20:28 - Session Start
Session initialized with goal: Mother federated query spec and review and openclaw
Working on branch: patina
Tagged as: session-20260202-202802-claude-start


### 00:03 - Update (covering since 20:28)

**Git Activity:**
- Commits this session: 0
- Files changed: 3 (parent mother SPEC.md updated, new delivery SPEC.md created, Cargo.lock)
- Last commit: 4 hours ago

**Work completed:**
- Deep dive into Mother architecture: cataloged all built components (1,849 lines Rust — graph.rs, internal.rs, routing.rs), 14 graph nodes, 3 manual edges, 18 registered repos, serve daemon, feedback loop
- Deep dive into [[openclaw/openclaw]] architecture: identified mandatory recall pattern, two-step search→get, candidate oversampling, compaction-triggered distillation
- Added [[steveyegge/gastown]] as ref repo #19: 2,957 commits, 4,754 functions, 179K lines Go. Multi-agent orchestration system with ephemeral context injection (`gt prime`), role-based delivery, zero RAG
- Synthesized three ref repo delivery philosophies: OpenClaw (question-time recall), Gastown (session-time injection), Patina (no delivery)
- Wrote [[mother-delivery]] spec at `layer/surface/build/feat/mother-delivery/SPEC.md` — 5 design changes (D1-D5) with exit criteria, measurement targets, architectural decision records
- Updated parent [[mother]] spec to reference delivery child spec and redefine Phase 1 as "Delivery + Federation"

**Discussion context:**
- Session crashed mid-investigation (3 parallel agents exploring scry output shape, context history, routing history). Recovered all threads on restart.
- Traced context tool origin to Dec 13, 2025 — created one day after MCP server because layer docs weren't indexed. User had forgotten it existed, which validated the delivery problem.
- Traced routing history: daemon (Dec 9) → brute-force (late Dec) → graph (Jan 5-7). Each solved a measured problem. G0 proved brute-force = 0% repo recall. Graph routing achieved 100%.
- User corrected adapter-agnostic concern: delivery should NOT live in CLAUDE.md. MCP tool responses are the only adapter-agnostic delivery channel.

**Key decisions:**
- v0.11.0 redefined as "Mother: Delivery + Federation" (was just "Federated Query"). Federation plumbing mostly built; delivery is the real gap.
- Delivery through MCP, not adapter files — tool descriptions and tool responses are the shared interface across Claude/Gemini adapters
- Beliefs as a default search channel (D1) identified as highest-impact change — directly addresses -0.05 task query delta
- Two-step retrieval (D3) before context briefing (D2) in implementation order — stabilize response shape before referencing it
- Routing simplified to graph-only (D4) — "All" strategy measured and proven inferior, daemon becomes transport not strategy

**Patterns observed:**
- Ref repo comparison is extremely productive for design — OpenClaw, Gastown, and Patina each solve different parts of the problem. No single system has all three of: rich knowledge, good delivery, federation.
- The delivery layer problem is universal — no ref repo solves automatic query-time belief routing. All use either static instruction, role-based injection, or user-triggered search.
- Session crash recovery works: parallel investigation threads can be re-launched and converge to same findings.

**Open questions (raised during spec review):**
1. D1 approach: separate BeliefOracle (new oracle), SQLite query (non-vector), or better tagging of existing SemanticOracle results?
2. D3 scope: two-step for MCP only, or also change CLI terminal output?
3. Recall directive placement: in context response only, or also as footer in scry responses?


### 00:10 - Final Update (covering since 00:03)

**Git Activity:**
- Commits this session: 1
- Files changed: 0
- Last commit: [[commit-e8d26665]] — spec: mother delivery layer (v0.11.0 redefined)

**Work completed:**
- Wired [[mother-delivery]] spec into all connection points: updated [[mother]] parent spec (Phase 1 redefined), `layer/core/build.md` (Current Focus rewritten with D1-D5 + spec link), [[v1-release]] spec (milestone renamed, pillar table updated — Epistemic→COMPLETE with 48 beliefs, Mother→delivery + federation)
- Verified no stale "Mother federated query" references remain in active specs (only in session archives, correct as historical)
- Committed checkpoint [[commit-e8d26665]]: 5 files, 353 insertions
- Reviewed spec together — identified 3 open design questions for next session

**Open design questions (sleeping on):**
1. **D1 BeliefOracle approach:** Option A (separate oracle, same USearch index, filter to 4B-5B ID range) vs Option B (SQLite FTS5 against beliefs table) vs Option C (better tagging of existing SemanticOracle results). Leaning toward A+B combined (mirrors SemanticOracle + LexicalOracle pattern for code).
2. **D3 two-step scope:** Snippets for MCP (token efficiency), full content for CLI (human UX). `--detail` flag overrides either default.
3. **Recall directive placement:** Full directive in `context` response, one-line hint in `scry` only when belief results are present ("3 beliefs matched — use content_type=beliefs for focused search").


### 06:54 - Design Resolution (continuation after context crash)

**Git Activity:**
- Commits this continuation: 0 (spec edits uncommitted)
- Files changed: 1 ([[mother-delivery]] SPEC.md — 392 insertions, 65 deletions)

**Work completed:**
- Resolved all 3 open design questions from previous session end:
  1. **D1 BeliefOracle:** Decided A+B combined (vector + FTS5). Mirrors [[SemanticOracle]] + [[LexicalOracle]] dual-channel pattern. Drafted full oracle design with Channel A (USearch filtered to 4B-5B), Channel B (new `beliefs_fts` table), internal weighted merge (0.7 vector + 0.3 text). See ADR-1.
  2. **D3 Two-step scope:** Decided snippets for BOTH MCP and CLI. Key insight from user: CLI is an LLM tool, not primarily human. Claude Code calls via Bash, OpenCode via exec. One behavior, two interfaces ([[adapter-pattern]]). See ADR-2.
  3. **D2 Recall placement:** Decided three-layer delivery (description nudge + response recall + graph breadcrumbs with dig-deeper commands). Belt-and-suspenders modeled after [[openclaw/openclaw]] dual-placement. See ADR-3.

- Updated [[mother-delivery]] SPEC.md evidence section with verified ref repo findings:
  - [[openclaw/openclaw]]: `memory-tool.ts` tool definitions, `system-prompt.ts` recall placement, `hybrid.ts` scoring (0.7 * vector + 0.3 * text), `manager.ts` architecture
  - [[steveyegge/gastown]]: `prime.go` context injection (lines 87-256), role templates (`mayor.md.tmpl`)
- Expanded D1 section with full `BeliefOracle` design: Oracle trait impl, OracleResult shape, QueryEngine wiring, IntentWeights update, scrape integration, module layout, federation, measurement plan
- Rewrote D2 as three-layer delivery with examples for each layer
- Rewrote D3 for both MCP and CLI with snippet format examples and detail fetch
- Added ADR-1 through ADR-5 with full rationale anchored in [[dependable-rust]], [[unix-philosophy]], [[adapter-pattern]]
- Updated exit criteria to 15 specific checkboxes across D1-D5
- Added platform stance: Mac-focused, Linux for containers, zero Windows
- Added adapter stance: Claude Code, OpenCode, Gemini CLI — minimize adapter surface

**Key decisions:**
- CLI is an LLM tool, not a human tool — this changes the entire D3 design (same snippets everywhere)
- Three-layer delivery is adapter-agnostic: no CLAUDE.md, no hooks, delivery through MCP tools + CLI commands only
- Graph breadcrumbs turn search results into a navigable knowledge structure — "here is small info, if you want bigger info here you go"

## Beliefs Captured: 0
_No beliefs captured this session_

## Session Classification
- Work Type: pattern-work
- Files Changed: 6
- Commits: 2
- Patterns Modified: 4
- Beliefs Captured: 0
- Session Tags: session-20260202-202802-claude-start..session-20260202-202802-claude-end

## User Prompts (14)

1. `deep dive into mother and what we have built and what we are planing to build in our mother feder...`
2. `i wonder what we can learn from openclaw that can make mother better? better than what i thought ...`
3. `the CLUADE.md focus confuses me as we should be more adapter agnostic. i love the 1. idea to spli...`
4. `we crashed [Pasted text #1 +422 lines]`
5. `i want you to run through this again: deep dive into mother and what we have built and what we ar...`
6. `delivery is the answer .. it should be a focus of mother as we need this to span multiple project...`
7. `yes lets write the spec`
8. `lets review it together and discuss`
9. `/session-update `
10. `is the spec all wired up?`
11. `lets commit this checkpoint and then discuss`
12. `i'm not sure going to sleep on it .. lets /session-end`
13. `we ran out of context and exited: I would like you to make sure we exit cleanly with /session-end...` (design resolution — resolved Q1 A+B, Q2 CLI=LLM tool, Q3 three-layer delivery)
14. `this is good enough to end our previous crashed session`
